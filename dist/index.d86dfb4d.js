function t(t,i,e,s){Object.defineProperty(t,i,{get:e,set:s,enumerable:!0,configurable:!0})}var i="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},e={},s={},n=i.parcelRequire62ee;null==n&&((n=function(t){if(t in e)return e[t].exports;if(t in s){var i=s[t];delete s[t];var n={id:t,exports:{}};return e[t]=n,i.call(n.exports,n,n.exports),n.exports}var r=new Error("Cannot find module '"+t+"'");throw r.code="MODULE_NOT_FOUND",r}).register=function(t,i){s[t]=i},i.parcelRequire62ee=n),n.register("kyEFX",(function(i,e){var s,n;t(i.exports,"register",(function(){return s}),(function(t){return s=t})),t(i.exports,"resolve",(function(){return n}),(function(t){return n=t}));var r={};s=function(t){for(var i=Object.keys(t),e=0;e<i.length;e++)r[i[e]]=t[i[e]]},n=function(t){var i=r[t];if(null==i)throw new Error("Could not resolve bundle with id "+t);return i}})),n("kyEFX").register(JSON.parse('{"GHvDZ":"index.d86dfb4d.js","gVigP":"main.e7ad44ea.js"}'));const r="loading";class h extends Error{}function o(t,i,e){return i in t?Object.defineProperty(t,i,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[i]=e,t}class l extends Error{}class c extends l{}class a extends l{}class d{static diff(t,i){return new p(t.x-i.x,t.y-i.y)}static mul(t,i){return new p(t.x*i,t.y*i)}static distance(t,i){return d.diff(t,i).length}static distance2(t,i){return d.diff(t,i).length2}static intersect(t,i){if(t.K===i.K)throw new c;if(isNaN(t.K)||isNaN(i.K))return isNaN(t.K)?i.makeVec2FromX(t._vec1.x):t.makeVec2FromX(i._vec1.x);{const e=(t.B-i.B)/(i.K-t.K);return t.makeVec2FromX(e)}}static dot(t,i){return t.x*i.x+t.y*i.y}static mirror(t,i){const e=i.direction.perpendicular;return t.diff(e.mul(2*d.dot(t,e)))}static scale(t,i){return new p(t.x/i.x,t.y/i.y)}}const u=1e-6,f=Math.sqrt(2);class p{get x(){return this._x}get y(){return this._y}set x(t){this._x=t,this._length=null}set y(t){this._y=t,this._length=null}get length(){return null===this._length&&(this._length=Math.sqrt(this.x*this.x+this.y*this.y),p.lengthCallsCount++),this._length}get length2(){return null===this._length2&&(this._length2=this._x*this._x+this._y*this._y,p.length2CallsCount++),this._length2}addSelf(t){return this._x+=t.x,this._y+=t.y,this._length=null,this}subSelf(t){return this._x-=t.x,this._y-=t.y,this._length=null,this}flipYSelf(){return this._y=-this._y,this}flipXSelf(){return this._x=-this._x,this}flipSelf(){return this._x=-this._x,this._y=-this._y,this}equals(t){return d.distance2(this,t)<1e-12}sum(t){return new p(this.x+t.x,this.y+t.y)}diff(t){return new p(this.x-t.x,this.y-t.y)}mul(t){return new p(this.x*t,this.y*t)}copy(){return new p(this.x,this.y)}applySelf(t){return this.x=t(this.x),this.y=t(this.y),this}get ort(){const t=this.length;return new p(this.x/t,this.y/t,1)}get perpendicular(){if(0===this.x){if(this.y>0)return p.Horizontal().ort;if(this.y<0)return p.Horizontal().ort.flipSelf();throw new a}if(0===this.y){if(this.x>0)return p.Vertical().ort;if(this.x<0)return p.Vertical().ort.flipSelf()}return new p(-this.y/this.x,1).ort}static Zero(){return new p(0,0)}static Horizontal(){return new p(1,0)}static Vertical(){return new p(0,1)}constructor(t,i,e){o(this,"_x",0),o(this,"_y",0),o(this,"_length",null),o(this,"_length2",null),this._x=t,this._y=i,e&&(this._length=e,this._length2=e*e)}}o(p,"lengthCallsCount",0),o(p,"length2CallsCount",0);class x{render(){}constructor(t,i){o(this,"position",p.Zero()),this.context=t,this.position=i}}class y extends x{render(){this.context.beginPath(),this.context.arc(this.position.x,this.position.y,this.r,0,2*Math.PI),this.context.fillStyle=this.color,this.context.fill()}constructor(t,i,e,s){super(t,i),o(this,"r",0),o(this,"color","#00ff00"),e&&(this.r=e),s&&(this.color=s)}}class g{inBetween(t){const i=d.diff(t,this._vec1).length+d.diff(this._vec2,t).length;return e=this._length,s=i,n=u,Math.abs(e-s)<n;var e,s,n}calculateKB(){this._vec1.y===this._vec2.y?(this._b=this._vec1.y,this._k=0):this._vec1.x===this._vec2.x?(this._b=NaN,this._k=NaN):(this._b=(this._vec1.x*this._vec2.y-this._vec1.y*this._vec2.x)/(this._vec1.x-this._vec2.x),this._k=(this._vec1.y-this._vec2.y)/(this._vec1.x-this._vec2.x))}makeVec2FromX(t){return new p(t,this._k*t+this._b)}copy(){return new g(this._vec1,this._vec2)}moveBy(t){this._vec1.addSelf(t),this._vec2.addSelf(t),this.calculateKB()}getPointProjection(t){const i=this.direction,e=d.diff(t,this._vec1),s=d.dot(i,e)/this.length;return this._vec1.sum(this.ort.mul(s))}get B(){return this._b}get K(){return this._k}get length(){return this._length}get direction(){return this._direction}get ort(){return this._ort}get vec1(){return this._vec1}get vec2(){return this._vec2}static Vertical(t){return new g(new p(t,0),new p(t,Number.MAX_SAFE_INTEGER))}static Horizontal(t){return new g(new p(0,t),new p(Number.MAX_SAFE_INTEGER,t))}constructor(t,i){o(this,"_vec1",p.Zero()),o(this,"_vec2",p.Zero()),o(this,"_k",0),o(this,"_b",0),this._vec1=t,this._vec2=i,this._direction=d.diff(this._vec1,this._vec2),this._length=this._direction.length,this._length2=this._direction.length2,this._ort=this._direction.ort,this.calculateKB()}}let _;var v;function m(t,i){let e=t,s=i;if(e.type>s.type){const t=function(t,i){return{a:i,b:t}}(e,s);e=t.a,s=t.b}switch(!0){case e.type===_.TypeBall&&s.type===_.TypeBall:return function(t,i){const e=d.diff(t.currentPosition,i.currentPosition),s=e.length,n=t.radius+i.radius;if(s<n){const r=e.ort,h=n-s;t.currentPosition.addSelf(d.mul(r,t.radius/n*h*t.bounceValue)),i.currentPosition.subSelf(d.mul(r,i.radius/n*h*i.bounceValue))}}(e,s);case e.type===_.TypeBall&&s.type===_.TypeImmovableBall:return function(t,i){const e=d.diff(t.currentPosition,i.currentPosition),s=e.length,n=t.radius+i.radius;if(s<n){const i=e.ort,r=n-s;t.currentPosition.addSelf(d.mul(i,t.radius/n*r*t.bounceValue))}}(e,s);case e.type===_.TypeBall&&s.type===_.TypeImmovableLine:return function(t,i){try{const e=i._line.getPointProjection(t.currentPosition);if(i._line.inBetween(e)){const i=d.diff(e,t.currentPosition);if(i.length<t.radius){const e=i.ort,s=t.radius-i.length;t.currentPosition.subSelf(d.mul(e,s*t.bounceValue))}}}catch(t){}}(e,s);default:return}}(v=_||(_={}))[v.TypeNull=0]="TypeNull",v[v.TypeBall=1]="TypeBall",v[v.TypeImmovableBall=2]="TypeImmovableBall",v[v.TypeImmovableLine=3]="TypeImmovableLine";class w{update(t){}accelerate(t){}collide(t){}addToGrid(t){}constructor(){o(this,"type",_.TypeNull),o(this,"previousPosition",p.Zero()),o(this,"currentPosition",p.Zero()),this.index=w.index++}}o(w,"index",0);class b extends w{update(t){const i=this.velocity;this.previousPosition=this.currentPosition.copy(),this.currentPosition.addSelf(i.addSelf(this.acc.mul(t*t))),this.acc=p.Zero()}accelerate(t){return this.acc.addSelf(t),this}setVelocity(t){return this.velocity=t,this}collide(t){m(this,t)}addToGrid(t){t.addObject(Math.floor(this.currentPosition.x),Math.floor(this.currentPosition.y),this)}get velocity(){return d.diff(this.currentPosition,this.previousPosition)}set velocity(t){this.previousPosition=d.diff(this.currentPosition,t)}get movementVector(){return new g(this.previousPosition,this.currentPosition)}constructor(t,i){super(),o(this,"acc",p.Zero()),o(this,"radius",10),o(this,"bounceValue",1.1),o(this,"type",_.TypeBall),o(this,"immovable",!1),this.previousPosition=t.copy(),this.currentPosition=t.copy(),void 0!==i&&(this.radius=i)}}class C{applyConstrain(t){}constructor(){}}class S extends C{get width(){return this._width}set width(t){this._width=t}get height(){return this._height}set height(t){this._height=t}applyConstrain(t){super.applyConstrain(t),t.currentPosition.x-t.radius<0&&(t.currentPosition.x=t.radius),t.currentPosition.x+t.radius>this._width&&(t.currentPosition.x=this._width-t.radius),t.currentPosition.y-t.radius<0&&(t.currentPosition.y=t.radius),t.currentPosition.y+t.radius>this._height&&(t.currentPosition.y=this._height-t.radius)}constructor(t,i){super(),o(this,"_width",0),o(this,"_height",0),this.width=t,this.height=i}}class j extends C{applyConstrain(t){super.applyConstrain(t);const i=t.currentPosition.diff(this.center),e=i.length,s=t.radius;if(e>this.radius-s){const e=i.ort;t.currentPosition=this.center.sum(e.mul(this.radius-s))}}constructor(t,i){super(),o(this,"center",p.Zero()),o(this,"radius",0),this.center=t,this.radius=i}}class P{getNextObject(t){return null}constructor(t){o(this,"solver",null),this.solver=t}}class T{constructor(t,i){o(this,"timeout",void 0),o(this,"object",void 0),this.timeout=t,this.object=i}}class G extends P{getNextObject(t){if(!(this.total>this.limit)&&(this.lastCreateTime+=1,this.lastCreateTime>this.delay)){const t=this.create(this.total);return this.lastCreateTime=0,this.total++,t}}constructor(t,i,e,s){super(t),this.limit=i,this.total=0,this.delay=e,this.create=s,this.lastCreateTime=0}}class O{addObject(t){this.objects.push(t)}clear(){this.objects=[],this.hightlight=!1}remove(t){const i=this.objects.findIndex((i=>i.index===t));-1!==i&&this.objects.splice(i,1)}get count(){return this.objects.length}constructor(){o(this,"objects",[]),o(this,"hightlight",!1)}}class I{get size(){return this._size}get width(){return this._width}set width(t){this._width=t,this.resize()}get height(){return this._height}set height(t){this._height=t,this.resize()}resize(){this.cells=[],this._size=this._width*this._height;for(let t=0;t<this._size;t++)this.cells.push(new O)}addObject(t,i,e){const s=Math.floor(t/this.cellSize.x),n=Math.floor(i/this.cellSize.y),r=s*this.width+n;isNaN(r)||r>=this.size||r<0||this.cells[r].addObject(e)}makeIndexFromVec(t){return t.x*this.width+t.y}makeIndexFromCoord(t,i){return t*this.width+i}addObjectToCells(t,i,e){const s=d.scale(t,this.cellSize).applySelf(Math.floor),n=d.scale(i,this.cellSize).applySelf(Math.floor),r=this.makeIndexFromVec(s),h=this.makeIndexFromVec(n);if(s.x===n.x)for(let t=r;t<h;t++)this.cells[t].addObject(e);else if(s.y===n.y)for(let t=r;t<h;t+=this.height)this.cells[t].addObject(e);else{let t=Math.min(s.x,n.x),i=Math.min(s.y,n.y),r=Math.max(s.x,n.x),h=Math.max(s.y,n.y)-i,o=this.makeIndexFromCoord(t,i);for(let i=0;i<=r-t;i++)for(let t=0;t<=h;t++){const s=o+i*this.height+t;this.cells[s].addObject(e)}}}clear(){for(let t=0;t<this.size;t++)this.cells[t].clear()}forEach(t){this.cells.forEach(((i,e)=>{const s=Math.floor(e/this.width),n=e-s*this.width;t(s,n,i,e)}))}hasCell(t,i){if(t<0||t>=this.size)return!1;const e=Math.floor(t/this.width),s=t-e*this.width;return!(s<=0&&i<0)&&(!(s===this.height-1&&i>0)&&(!(0===e&&i<0)&&!(e>=this.width-1&&i>0)))}constructor(t,i,e){o(this,"cells",[]),this._width=t,this._height=i,this.cellSize=e,this.resize()}}class z{configure(){this.gravity=new p(0,100),this.useFixedTime=!0,this.step=.017/this.subSteps;this.cellSize=new p(this.worldSize.x/30,this.worldSize.y/30),this.collisionGrid=new I(30,30,this.cellSize)}addObject(t){this.objects.push(t)}update(t){const i=this.useFixedTime?this.step:t/this.subSteps;for(let t=0;t<this.subSteps;t++)this.addObjectsToGrid(),this.processCollisions(),this.applyGravity(),this.updateObjects(i),this.applyConstrains()}addObjectsToGrid(){this.collisionGrid.clear(),this.objects.forEach(((t,i)=>{t.addToGrid(this.collisionGrid)}))}updateObjects(t){this.objects.forEach((i=>i.update(t)))}applyGravity(){this.objects.forEach((t=>t.accelerate(this.gravity)))}applyConstrains(){this.objects.forEach((t=>this.constrains.applyConstrain(t)))}processCollisionsInCell(t,i){i.objects.forEach((i=>{t!==i&&(t.immovable&&i.immovable||t.collide(i))}))}processCell(t){this.collisionGrid.cells[t].objects.forEach((i=>{this.processCollisionsInCell(i,this.collisionGrid.cells[t]),this.collisionGrid.hasCell(t,-1)&&this.processCollisionsInCell(i,this.collisionGrid.cells[t-1]),this.collisionGrid.hasCell(t,1)&&this.processCollisionsInCell(i,this.collisionGrid.cells[t+1]),this.collisionGrid.hasCell(t+this.collisionGrid.height,-1)&&this.processCollisionsInCell(i,this.collisionGrid.cells[t+this.collisionGrid.height-1]),this.collisionGrid.hasCell(t+this.collisionGrid.height,0)&&this.processCollisionsInCell(i,this.collisionGrid.cells[t+this.collisionGrid.height]),this.collisionGrid.hasCell(t+this.collisionGrid.height,1)&&this.processCollisionsInCell(i,this.collisionGrid.cells[t+this.collisionGrid.height+1]),this.collisionGrid.hasCell(t-this.collisionGrid.height,-1)&&this.processCollisionsInCell(i,this.collisionGrid.cells[t-this.collisionGrid.height-1]),this.collisionGrid.hasCell(t-this.collisionGrid.height,0)&&this.processCollisionsInCell(i,this.collisionGrid.cells[t-this.collisionGrid.height]),this.collisionGrid.hasCell(t-this.collisionGrid.height,1)&&this.processCollisionsInCell(i,this.collisionGrid.cells[t-this.collisionGrid.height+1])}))}processCollisions(){for(let t=0;t<this.collisionGrid.size;t++)this.processCell(t)}constructor(t){o(this,"objects",[]),o(this,"constrains",null),o(this,"gravity",p.Zero()),o(this,"subSteps",4),o(this,"useFixedTime",!0),this.objects=[],this.worldSize=t.copy(),this.configure()}}class E extends x{render(){this.context.fillStyle=this.color,this.context.fillRect(this.position.x,this.position.y,this.position.x+this.size.x,this.position.y+this.size.y)}constructor(t,i,e,s){super(t,i),o(this,"size",p.Zero()),o(this,"color","#00ff00"),this.size=e,s&&(this.color=s)}}class k{update(){this.renderItem.position=this.ballsObject.currentPosition}render(){this.update(),this.renderItem.render()}constructor(t,i){o(this,"ballsObject",null),o(this,"renderItem",null),this.ballsObject=t,this.renderItem=i}}class F extends b{update(t){this.currentPosition=this._fixedPosition,this.previousPosition=this._fixedPosition}addToGrid(t){const i=new p(this.radius*f,this.radius*f),e=this.currentPosition.sum(i),s=this.currentPosition.diff(i);t.addObjectToCells(e,s,this)}constructor(t,i){super(t,i),o(this,"type",_.TypeImmovableBall),o(this,"immovable",!0),o(this,"_fixedPosition",null),this._fixedPosition=t.copy()}}class N extends k{update(){super.update(),this.renderItem.direction=this.ballsObject._direction}constructor(t,i){super(t),o(this,"ballsObject",null),this.ballsObject=t,this.renderItem=i}}class M extends b{update(t){this.currentPosition=this._line._vec1,this.previousPosition=this._line._vec2}addToGrid(t){t.addObjectToCells(this._line._vec1,this._line._vec2,this)}constructor(t,i){super(t,0),o(this,"type",_.TypeImmovableLine),o(this,"immovable",!0),this._direction=i,this._line=new g(this.currentPosition.copy(),this.currentPosition.copy().sum(this._direction))}}class R extends x{render(){this.context.strokeStyle=this.color,this.context.beginPath(),this.context.moveTo(this.position.x,this.position.y),this.context.lineTo(this.position.x+this.direction.x,this.position.y+this.direction.y),this.context.stroke()}constructor(t,i,e,s){super(t,i),o(this,"direction",p.Zero()),o(this,"color","#00ff00"),this.direction=e,s&&(this.color=s)}}class V extends y{render(){super.render(),this.context.fillStyle=this.textColor,this.context.textBaseline="middle",this.context.textAlign="center",this.context.fillText(this.text,this.position.x,this.position.y)}constructor(t,i,e,s,n,r){super(t,i,e,s),o(this,"text",""),o(this,"textColor","#ffffff"),this.text=n,r&&(this.textColor=r)}}class B extends E{render(){this.context.strokeStyle=this.color,this.context.strokeRect(this.position.x,this.position.y,this.size.x,this.size.y)}constructor(t,i,e,s){super(t,i,e,s)}}new T(1,new b(new p(10,10))),new T(2,new b(new p(10,10))),new T(3,new b(new p(10,10)));const Z=[new p(60,110),new p(130,490),new p(330,490),new p(400,110)],L=[[Z[0],d.diff(Z[0],Z[1]).flipSelf()],[Z[1],d.diff(Z[1],Z[2]).flipSelf()],[Z[2],d.diff(Z[2],Z[3]).flipSelf()]],A={57:"#ffffff",78:"#ffffff",71:"#ffffff",86:"#ffffff",200:"#ffffff",202:"#ffffff",218:"#ffffff"};class K{configure(){this.solver=new z(new p(this.canvas.width,this.canvas.height)),this.context.font="10px serif",this.switchToViewportConstrain(),this.solver.constrains=this.constrains;new p(this.canvas.width/2,this.canvas.height/2);const t=new p(10,10),i=new p(3,-3).mul(1/this.solver.subSteps);this.generator=new G(this.solver,600,7,(e=>new k(new b(t,5).setVelocity(i),new V(this.context,p.Zero(),5,A[e],"","#000000")))),this.addObject(new k(new F(new p(230,50),30),new y(this.context,p.Zero(),30,"#ff0000"))),L.forEach((t=>{this.addObject(new N(new M(t[0],t[1]),new R(this.context,p.Zero(),p.Zero(),"#ffffff")))}))}addObject(t){this.objects.push(t),this.solver.addObject(t.ballsObject)}update(t){this.solver.update(t)}generatorsTick(t){const i=this.generator.getNextObject(t);i&&this.addObject(i)}tick(){this.step<0&&(this.step=0),this.generatorsTick(this.step/1e3),this.update(this.step/1e3),this.clear(),this.renderItems(),this.renderGrid(),this.printFPS(),p.lengthCallsCount=0}renderItems(){this.items.forEach((t=>t.render())),this.objects.forEach((t=>t.render()))}printText(t,i,e){this.context.fillStyle="#ffffff",this.context.textAlign="start",this.context.fillText(t,i,e)}printFPS(){this.context.fillStyle="#000000",this.context.fillRect(0,0,100,60),this.printText(`${Math.round(this.step)} ms / ${Math.round(1e3/this.step)} FPS`,0,10),this.printText(`Length calls: ${p.lengthCallsCount}`,0,20),this.printText(`Lenght2 calls: ${p.length2CallsCount}`,0,30),this.printText(`Objects: ${this.objects.length}`,0,40),this.printText(`Compares per object: ${Math.round(p.lengthCallsCount/this.objects.length)}`,0,50)}clear(){this.context.fillStyle="rgba(0, 0, 0, 0.9)",this.context.fillRect(0,0,this.canvas.width,this.canvas.height)}start(){self.requestAnimationFrame?self.requestAnimationFrame(this.nextFrame):setInterval(this.nextInterval,16)}renderGrid(){this.solver.collisionGrid.forEach(((t,i,e,s)=>{const n=new p(t*this.solver.cellSize.x,i*this.solver.cellSize.y),r=new B(this.context,n,this.solver.cellSize.diff(new p(5,5)),e.count>0?"#ff0000":"#00ff00");e.hightlight&&(this.context.lineWidth=10),r.render(),this.context.lineWidth=1,this.printText(s,n.x+this.solver.cellSize.x/2,n.y+this.solver.cellSize.y/2)}))}switchToCircleConstrain(){this.constrains=new j(new p(this.canvas.width/2,this.canvas.height/2),this.canvas.height/2),this.items.push(new y(this.context,this.canvas.width/2,this.canvas.height/2,this.canvas.height/2,"#000000"))}switchToViewportConstrain(){this.constrains=new S(this.canvas.width,this.canvas.height)}constructor(t){o(this,"objects",[]),o(this,"constrains",null),o(this,"solver",null),o(this,"nextFrame",(t=>{this.step=t-this.timeRenderEnd,this.step<0&&(this.step=0),this.tick(),this.timeRenderEnd=t,self.requestAnimationFrame(this.nextFrame)})),o(this,"nextInterval",(()=>{this.timeRenderStart=performance.now(),this.step=this.timeRenderStart-this.timeRenderEnd,this.step<0&&(this.step=0),this.tick(),this.timeRenderEnd=performance.now()})),this.canvas=t,this.context=this.canvas.getContext("2d"),this.timeRenderStart=performance.now(),this.timeRenderEnd=performance.now(),this.step=0,this.objects=[],this.items=[],this.generator=null,this.solver=null,this.configure()}}var X,q={};X=function(t,i,e){if(i===self.location.origin)return t;var s=e?"import "+JSON.stringify(t)+";":"importScripts("+JSON.stringify(t)+");";return URL.createObjectURL(new Blob([s],{type:"application/javascript"}))};let H=new URL(n("kyEFX").resolve("gVigP"),import.meta.url);var $;q=X(H.toString(),H.origin,!0),$=function(){console.log("Init application");const t=function(t){const i=document.querySelector(t);if(!i)throw new h(t);return i}("#image_canvas");if(t.transferControlToOffscreen){console.log("Render in worker");const i=new Worker(q),e=t.transferControlToOffscreen();i.postMessage({canvas:e},[e])}else console.log("Render in main thread"),new K(t).start()},document.readyState!==r?$():document.addEventListener("DOMContentLoaded",$);
//# sourceMappingURL=index.d86dfb4d.js.map
