!function(){function t(t,e,n,i){Object.defineProperty(t,e,{get:n,set:i,enumerable:!0,configurable:!0})}var e={};t(e,"Vec2ExceptionParallel",(function(){return r}),(function(t){return r=t})),t(e,"Vec2ExceptionNoPerpendicularVectorToZeroVector",(function(){return s}),(function(t){return s=t}));var n,i=(n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},n(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),o=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e}(Error),r=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e}(o),s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e}(o),c=function(){function t(){}return t.diff=function(t,e){return new l(t.x-e.x,t.y-e.y)},t.mul=function(t,e){return new l(t.x*e,t.y*e)},t.distance=function(e,n){return t.diff(e,n).length},t.distance2=function(e,n){return t.diff(e,n).length2},t.intersect=function(t,n){if(t.K===n.K)throw new(0,e.Vec2ExceptionParallel);if(isNaN(t.K)||isNaN(n.K))return isNaN(t.K)?n.makeVec2FromX(t._vec1.x):t.makeVec2FromX(n._vec1.x);var i=(t.B-n.B)/(n.K-t.K);return t.makeVec2FromX(i)},t.dot=function(t,e){return t.x*e.x+t.y*e.y},t.mirror=function(e,n){var i=n.direction.perpendicular;return e.diff(i.mul(2*t.dot(e,i)))},t.scale=function(t,e){return new l(t.x/e.x,t.y/e.y)},t}(),a=1e-6,u=Math.sqrt(2);var l=function(){function t(t,e,n){this._x=0,this._y=0,this._length=null,this._length2=null,this._x=t,this._y=e,n&&(this._length=n,this._length2=n*n)}return Object.defineProperty(t.prototype,"x",{get:function(){return this._x},set:function(t){this._x=t,this._length=null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._y},set:function(t){this._y=t,this._length=null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return null===this._length&&(this._length=Math.sqrt(this.x*this.x+this.y*this.y),t.lengthCallsCount++),this._length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"length2",{get:function(){return null===this._length2&&(this._length2=this._x*this._x+this._y*this._y,t.length2CallsCount++),this._length2},enumerable:!1,configurable:!0}),t.prototype.addSelf=function(t){return this._x+=t.x,this._y+=t.y,this._length=null,this},t.prototype.subSelf=function(t){return this._x-=t.x,this._y-=t.y,this._length=null,this},t.prototype.flipYSelf=function(){return this._y=-this._y,this},t.prototype.flipXSelf=function(){return this._x=-this._x,this},t.prototype.flipSelf=function(){return this._x=-this._x,this._y=-this._y,this},t.prototype.equals=function(t){return c.distance2(this,t)<1e-12},t.prototype.sum=function(e){return new t(this.x+e.x,this.y+e.y)},t.prototype.diff=function(e){return new t(this.x-e.x,this.y-e.y)},t.prototype.mul=function(e){return new t(this.x*e,this.y*e)},t.prototype.copy=function(){return new t(this.x,this.y)},t.prototype.applySelf=function(t){return this.x=t(this.x),this.y=t(this.y),this},t.prototype.isInsideRect=function(t,e){var n=Math.min(t.x,e.x),i=Math.min(t.y,e.y),o=Math.max(t.x,e.x),r=Math.max(t.y,e.y);return this._x>=n&&this._x<=o&&this._y>=i&&this._y<=r},Object.defineProperty(t.prototype,"ort",{get:function(){var e=this.length;return new t(this.x/e,this.y/e,1)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"perpendicular",{get:function(){if(0===this.x){if(this.y>0)return t.Horizontal().ort;if(this.y<0)return t.Horizontal().ort.flipSelf();throw new(0,e.Vec2ExceptionNoPerpendicularVectorToZeroVector)}if(0===this.y){if(this.x>0)return t.Vertical().ort;if(this.x<0)return t.Vertical().ort.flipSelf()}return new t(-this.y/this.x,1).ort},enumerable:!1,configurable:!0}),t.Zero=function(){return new t(0,0)},t.Horizontal=function(){return new t(1,0)},t.Vertical=function(){return new t(0,1)},t.Down=function(e){return new t(0,e)},t.Right=function(e){return new t(e,0)},t.lengthCallsCount=0,t.length2CallsCount=0,t}(),h=function(){function t(){this.objects=[],this.highlight=!1}return t.prototype.addObject=function(e){this.objects.length>=t.MAX_OBJECT_IN_CELL||this.objects.push(e)},t.prototype.clear=function(){this.objects=[],this.highlight=!1},t.prototype.remove=function(t){var e=this.objects.findIndex((function(e){return e.index===t}));-1!==e&&this.objects.splice(e,1)},Object.defineProperty(t.prototype,"count",{get:function(){return this.objects.length},enumerable:!1,configurable:!0}),t.MAX_OBJECT_IN_CELL=100,t}(),f=function(){function t(t,e,n){this.cells=[],this.index2xy=[],this.adjacentCells=[],this._width=t,this._height=e,this.cellSize=n,this.resize()}return Object.defineProperty(t.prototype,"size",{get:function(){return this._size},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._width},set:function(t){this._width=t,this.resize()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},set:function(t){this._height=t,this.resize()},enumerable:!1,configurable:!0}),t.prototype.recalculateIndex2xy=function(){this.index2xy=[];for(var t=0;t<this._size;t++)this.index2xy.push(this.makeVecFromIndex(t))},t.prototype.recalculateCollisionCells=function(){var t=this;this.adjacentCells=[],this.cells.forEach((function(e,n){var i=t.getVecFromIndex(n),o=[];o.push(e),i.y>0&&o.push(t.cells[t.makeIndexFromCoord(i.x,i.y-1)]),i.y+1<t._height&&o.push(t.cells[t.makeIndexFromCoord(i.x,i.y+1)]),i.x>0&&(i.y>0&&o.push(t.cells[t.makeIndexFromCoord(i.x-1,i.y-1)]),o.push(t.cells[t.makeIndexFromCoord(i.x-1,i.y)]),i.y+1<t._height&&o.push(t.cells[t.makeIndexFromCoord(i.x-1,i.y+1)])),i.x+1<t._width&&(i.y>0&&o.push(t.cells[t.makeIndexFromCoord(i.x+1,i.y-1)]),o.push(t.cells[t.makeIndexFromCoord(i.x+1,i.y)]),i.y+1<t._height&&o.push(t.cells[t.makeIndexFromCoord(i.x+1,i.y+1)])),t.adjacentCells[n]=o}))},t.prototype.getVecFromIndex=function(t){return this.index2xy[t]},t.prototype.resize=function(){this.cells=[],this._size=this._width*this._height;for(var t=0;t<this._size;t++)this.cells.push(new h);this.recalculateIndex2xy(),this.recalculateCollisionCells()},t.prototype.addObject=function(t,e,n){var i=Math.trunc(t/this.cellSize.x),o=Math.trunc(e/this.cellSize.y),r=i*this._height+o;this.addObjectByIndex(r,n)},t.prototype.addObjectByIndex=function(t,e){!isNaN(t)&&t>=0&&t<this.size&&this.cells[t].addObject(e)},t.prototype.makeIndexFromVec=function(t){return t.x*this._height+t.y},t.prototype.makeIndexFromCoord=function(t,e){return t*this._height+e},t.prototype.makeVecFromIndex=function(t){var e=Math.trunc(t/this._height),n=t-e*this._height;return new l(e,n)},t.prototype.addObjectToCells=function(t,e,n){var i=c.scale(t,this.cellSize).applySelf(Math.trunc),o=c.scale(e,this.cellSize).applySelf(Math.trunc),r=this.makeIndexFromVec(i),s=this.makeIndexFromVec(o),a=Math.min(i.x,o.x),u=Math.min(i.y,o.y),l=Math.max(i.x,o.x),h=Math.max(i.y,o.y);if(!(l>=this._width||a<0||u<0||h>=this._height))if(i.x===o.x)for(var f=r;f<s;f++)this.cells[f].addObject(n);else if(i.y===o.y)for(f=r;f<s;f+=this.height)this.cells[f].addObject(n);else for(var p=h-u,y=this.makeIndexFromCoord(a,u),d=0;d<=l-a;d++)for(var v=0;v<=p;v++){f=y+this.makeIndexFromCoord(d,v);this.addObjectByIndex(f,n)}},t.prototype.clear=function(){this.cells.forEach((function(t){return t.clear()}))},t.prototype.forEach=function(t){var e=this;this.cells.forEach((function(n,i){var o=e.getVecFromIndex(i);t(o.x,o.y,n,i)}))},t.prototype.hasCell=function(t,e){if(t<0||t>=this.size)return!1;var n=this.getVecFromIndex(t),i=n.x,o=n.y;return!(o<=0&&e<0)&&(!(o===this.height-1&&e>0)&&(!(0===i&&e<0)&&!(i>=this.width-1&&e>0)))},t}(),p=function(){function t(t,e){this.objects=[],this.constrains=null,this.gravity=l.Zero(),this.subSteps=4,this.useFixedTime=!0,this.stats=e,this.objects=[],this.worldSize=t.copy(),this.configure()}return t.prototype.reset=function(){this.objects=[],this.collisionGrid.clear()},t.prototype.configure=function(){this.gravity=new l(0,100),this.useFixedTime=!0,this.step=.017/this.subSteps;var t=Math.round(this.worldSize.x/16),e=Math.round(this.worldSize.y/16);this.cellSize=new l(this.worldSize.x/t,this.worldSize.y/e),this.collisionGrid=new f(t,e,this.cellSize)},t.prototype.addObject=function(t){this.objects.push(t)},t.prototype.update=function(t){for(var e=this.useFixedTime?this.step:t/this.subSteps,n=0;n<this.subSteps;n++)this.addObjectsToGrid(),this.processCollisions(),this.applyGravity(),this.updateObjects(e),this.applyConstrains()},t.prototype.addObjectsToGrid=function(){var t=this;this.collisionGrid.clear(),this.objects.forEach((function(e,n){e.addToGrid(t.collisionGrid)}))},t.prototype.updateObjects=function(t){this.objects.forEach((function(e){return e.update(t)}))},t.prototype.applyGravity=function(){var t=this;this.objects.forEach((function(e){return e.accelerate(t.gravity)}))},t.prototype.applyConstrains=function(){var t=this;this.objects.forEach((function(e){return t.constrains.applyConstrain(e)}))},t.prototype.processCollisionsInCell=function(t,e){this.stats.addStats("processCollisionsInCell.calls",1),e.objects.forEach((function(e){t!==e&&(t.immovable&&e.immovable||t.collide(e))}))},t.prototype.processCell=function(t){var e=this;this.stats.addStats("processCell.calls",1);var n=this.collisionGrid.cells[t];n.objects.forEach((function(i){e.collisionGrid.adjacentCells[t].forEach((function(t){t===n&&1===t.objects.length||e.processCollisionsInCell(i,t)}))}))},t.prototype.processCollisions=function(){for(var t=0;t<this.collisionGrid.size;t++)this.processCell(t)},t}();function y(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var d=function(){function t(t,e){this.position=l.Zero(),this.context=t,this.position=e}return t.prototype.render=function(){},t.prototype.queue=function(){},t}();class v extends d{render(){this.context.fillStyle=this.color,this.context.fillRect(this.position.x,this.position.y,this.position.x+this.size.x,this.position.y+this.size.y)}constructor(t,e,n,i){super(t,e),y(this,"size",l.Zero()),y(this,"color","#00ff00"),this.size=n,i&&(this.color=i)}}class b extends v{render(){this.context.strokeStyle=this.color,this.context.strokeRect(this.position.x,this.position.y,this.size.x,this.size.y)}queue(){}constructor(t,e,n,i){super(t,e,n,i)}}var _={};t(_,"Scene1",(function(){return $}),(function(t){return $=t}));var g=function(t){this.engine=t},x=function(){function t(t){this.solver=null,this.solver=t}return t.prototype.getNextObjects=function(t){return[]},t}();class m extends x{getNextObjects(t){if(this.total>this.limit)return[];if(this.lastCreateTime+=1,this.lastCreateTime>this.delay){const t=this.create(this.total);return this.lastCreateTime=0,this.total+=t.length,t}return[]}constructor(t,e,n,i){super(t),this.limit=e,this.total=0,this.delay=n,this.create=i,this.lastCreateTime=0}}var w={};t(w,"Circle",(function(){return P}),(function(t){return P=t}));var j=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),P=function(t){function e(e,n,i,o){var r=t.call(this,e,n)||this;return r.r=0,r.color="#00ff00",i&&(r.r=i),o&&(r.color=o),r}return j(e,t),e.prototype.render=function(){this.context.beginPath(),this.context.arc(this.position.x,this.position.y,this.r,0,2*Math.PI),this.context.fillStyle=this.color,this.context.fill()},e}(d),O={};t(O,"BallsObject",(function(){return V}),(function(t){return V=t}));var C,S,I=function(){function t(t,e){this._vec1=l.Zero(),this._vec2=l.Zero(),this._k=0,this._b=0,this._vec1=t,this._vec2=e,this._direction=c.diff(this._vec1,this._vec2),this._length=this._direction.length,this._length2=this._direction.length2,this._ort=this._direction.ort,this.calculateKB()}return t.prototype.inBetween=function(t){var e,n,i,o=c.diff(t,this._vec1).length+c.diff(this._vec2,t).length;return e=this._length,n=o,i=a,Math.abs(e-n)<i},t.prototype.inBetweenFast=function(t){return t.isInsideRect(this._vec1,this._vec2)},t.prototype.calculateKB=function(){this._vec1.y===this._vec2.y?(this._b=this._vec1.y,this._k=0):this._vec1.x===this._vec2.x?(this._b=NaN,this._k=NaN):(this._b=(this._vec1.x*this._vec2.y-this._vec1.y*this._vec2.x)/(this._vec1.x-this._vec2.x),this._k=(this._vec1.y-this._vec2.y)/(this._vec1.x-this._vec2.x))},t.prototype.makeVec2FromX=function(t){return new l(t,this._k*t+this._b)},t.prototype.copy=function(){return new t(this._vec1,this._vec2)},t.prototype.moveBy=function(t){this._vec1.addSelf(t),this._vec2.addSelf(t),this.calculateKB()},t.prototype.getPointProjection=function(t){var e=this.direction,n=c.diff(t,this._vec1),i=c.dot(e,n)/this.length;return this._vec1.sum(this.ort.mul(i))},Object.defineProperty(t.prototype,"B",{get:function(){return this._b},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"K",{get:function(){return this._k},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return this._length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"direction",{get:function(){return this._direction},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ort",{get:function(){return this._ort},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vec1",{get:function(){return this._vec1},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vec2",{get:function(){return this._vec2},enumerable:!1,configurable:!0}),t.Vertical=function(e){return new t(new l(e,0),new l(e,Number.MAX_SAFE_INTEGER))},t.Horizontal=function(e){return new t(new l(0,e),new l(Number.MAX_SAFE_INTEGER,e))},t}();function T(t,e,n){try{var i=e.getPointProjection(t.currentPosition);if(e.inBetweenFast(i)){var o=c.diff(i,t.currentPosition);if(o.length2<t.radius2){var r=o.ort,s=t.radius-o.length;t.currentPosition.subSelf(c.mul(r,s*t.bounceValue*n))}}}catch(t){}}function k(t,e){var n,i=t,o=e;if(i.type>o.type){var r=function(t,e){return{a:e,b:t}}(i,o);i=r.a,o=r.b}switch(!0){case i.type===C.TypeBall&&o.type===C.TypeBall:return function(t,e){var n=c.diff(t.currentPosition,e.currentPosition),i=n.length,o=t.radius+e.radius;if(i<o){var r=n.ort,s=o-i;t.currentPosition.addSelf(c.mul(r,t.radius/o*s*t.bounceValue)),e.currentPosition.subSelf(c.mul(r,e.radius/o*s*e.bounceValue))}}(i,o);case i.type===C.TypeBall&&o.type===C.TypeImmovableBall:return function(t,e){var n=c.diff(t.currentPosition,e.currentPosition),i=n.length,o=t.radius+e.radius;if(i<o){var r=n.ort,s=o-i;t.currentPosition.addSelf(c.mul(r,t.radius/o*s*t.bounceValue*e.bounceValue))}}(i,o);case i.type===C.TypeBall&&o.type===C.TypeImmovableLine:return void T(i,(n=o)._line,n.bounceValue);case i.type===C.TypeBall&&o.type===C.TypeImmovablePolygon:return function(t,e){e.lines.forEach((function(n){return T(t,n,e.bounceValue)}))}(i,o);default:return}}(S=C||(C={}))[S.TypeNull=0]="TypeNull",S[S.TypeBall=1]="TypeBall",S[S.TypeImmovableBall=2]="TypeImmovableBall",S[S.TypeImmovableLine=3]="TypeImmovableLine",S[S.TypeImmovablePolygon=4]="TypeImmovablePolygon";var M=function(){function t(){this.type=C.TypeNull,this.previousPosition=l.Zero(),this.currentPosition=l.Zero(),this.index=t.index++}return t.prototype.update=function(t){},t.prototype.accelerate=function(t){},t.prototype.collide=function(t){},t.prototype.addToGrid=function(t){},t.index=0,t}(),B=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),E=Math.pow(10,2),V=function(t){function e(e,n){var i=t.call(this)||this;return i.acc=l.Zero(),i.radius=10,i.bounceValue=1.1,i.motionReduce=1,i.type=C.TypeBall,i.immovable=!1,i.previousPosition=e.copy(),i.currentPosition=e.copy(),void 0!==n&&(i.radius=n),i._radius2=i.radius*i.radius,i}return B(e,t),e.prototype.update=function(t){var e=this.velocity.mul(this.motionReduce);e.length2>E&&(e=e.ort.mul(10)),this.previousPosition=this.currentPosition.copy(),this.currentPosition.addSelf(e.addSelf(this.acc.mul(t*t))),this.acc=l.Zero()},e.prototype.accelerate=function(t){return this.acc.addSelf(t),this},e.prototype.setVelocity=function(t){return this.velocity=t,this},e.prototype.collide=function(t){k(this,t)},e.prototype.addToGrid=function(t){t.addObject(Math.floor(this.currentPosition.x),Math.floor(this.currentPosition.y),this)},e.prototype.moveBy=function(t){this.currentPosition.addSelf(t)},e.prototype.moveTo=function(t){this.currentPosition=t.copy()},e.prototype.isPointInsideObject=function(t){return c.distance(this.currentPosition,t)<this.radius},Object.defineProperty(e.prototype,"velocity",{get:function(){return c.diff(this.currentPosition,this.previousPosition)},set:function(t){this.previousPosition=c.diff(this.currentPosition,t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"movementVector",{get:function(){return new I(this.previousPosition,this.currentPosition)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"radius2",{get:function(){return this._radius2},enumerable:!1,configurable:!0}),e}(M),F=function(){function t(t,e){this.ballsObject=null,this.renderItem=null,this.ballsObject=t,this.renderItem=e}return t.prototype.update=function(){this.renderItem.position=this.ballsObject.currentPosition},t.prototype.render=function(){this.update(),this.renderItem.render()},t}(),R={};t(R,"ImmovableBallsObject",(function(){return A}),(function(t){return A=t}));var z=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),A=function(t){function e(e,n){var i=t.call(this,e,n)||this;return i.type=C.TypeImmovableBall,i.immovable=!0,i.bounceValue=.5,i._fixedPosition=null,i._fixedPosition=e.copy(),i}return z(e,t),e.prototype.update=function(t){this.currentPosition=this._fixedPosition,this.previousPosition=this._fixedPosition},e.prototype.addToGrid=function(t){var e=new l(this.radius*u,this.radius*u),n=this.currentPosition.sum(e),i=this.currentPosition.diff(e);t.addObjectToCells(n,i,this)},e.prototype.moveTo=function(t){this.currentPosition=t.copy(),this.previousPosition=t.copy(),this._fixedPosition=t.copy()},e}(O.BallsObject);class N extends F{update(){super.update(),this.renderItem.direction=this.ballsObject._direction}constructor(t,e){super(t),y(this,"ballsObject",null),this.ballsObject=t,this.renderItem=e}}var G={};t(G,"ImmovableLineObject",(function(){return L}),(function(t){return L=t}));var Z=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),L=function(t){function e(e,n){var i=t.call(this,e,0)||this;return i.type=C.TypeImmovableLine,i.immovable=!0,i.bounceValue=1,i._direction=n,i._line=new I(i.currentPosition.copy(),i.currentPosition.copy().sum(i._direction)),i}return Z(e,t),e.prototype.update=function(t){this.currentPosition=this._line._vec1,this.previousPosition=this._line._vec2},e.prototype.addToGrid=function(t){t.addObjectToCells(this._line._vec1,this._line._vec2,this)},e}(O.BallsObject);class D extends d{render(){this.context.strokeStyle=this.color,this.context.beginPath(),this.context.moveTo(this.position.x,this.position.y),this.context.lineTo(this.position.x+this.direction.x,this.position.y+this.direction.y),this.context.stroke()}constructor(t,e,n,i){super(t,e),y(this,"direction",l.Zero()),y(this,"color","#00ff00"),this.direction=n,i&&(this.color=i)}}var X={};t(X,"CircleWithText",(function(){return q}),(function(t){return q=t}));var K=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),q=function(t){function e(e,n,i,o,r,s){var c=t.call(this,e,n,i,o)||this;return c.text="",c.textColor="#ffffff",c.text=r,s&&(c.textColor=s),c}return K(e,t),e.prototype.render=function(){t.prototype.render.call(this),this.context.fillStyle=this.textColor,this.context.textBaseline="middle",this.context.textAlign="center",this.context.fillText(this.text,this.position.x,this.position.y)},e}(w.Circle);function U(t){var e=.005,n=Math.floor(127*Math.sin(e*t+0)+128),i=Math.floor(127*Math.sin(e*t+2)+128),o=Math.floor(127*Math.sin(e*t+4)+128);return"rgba(".concat(n,", ").concat(i,", ").concat(o,", 1)")}var W=function(){};class Y extends W{get width(){return this._width}set width(t){this._width=t}get height(){return this._height}set height(t){this._height=t}applyConstrain(t){t.currentPosition.x-t.radius<0&&(t.currentPosition.x=t.radius),t.currentPosition.x+t.radius>this._width&&(t.currentPosition.x=this._width-t.radius),t.currentPosition.y-t.radius<0&&(t.currentPosition.y=t.radius),t.currentPosition.y+t.radius>this._height&&(t.currentPosition.y=this._height-t.radius)}constructor(t,e){super(),y(this,"_width",0),y(this,"_height",0),this.width=t,this.height=e}}var H=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),J=[new l(0,0),new l(70,380),new l(270,380),new l(340,0)],Q=[[J[0],c.diff(J[0],J[1]).flipSelf()],[J[1],c.diff(J[1],J[2]).flipSelf()],[J[2],c.diff(J[2],J[3]).flipSelf()]],$=function(t){function e(e){var n=t.call(this,e)||this;n.canMoveRedObject=!1;var i=new l(n.engine.canvas.width/2,n.engine.canvas.height/2);return n.generator=n.createBallsGenerator(i,new l(300,300),new l(2,-2)),n.createBottomBouncyLine(),n.createMilkShake(i),n.createActor(),n.initConstrain(),n}return H(e,t),e.prototype.createBallsGenerator=function(t,e,n){var i=this,o=t.diff(e),r=n.mul(1/this.engine.solver.subSteps);return new m(this.engine.solver,1700,7,(function(t){return[new F(new(0,O.BallsObject)(o,5).setVelocity(r),new(0,X.CircleWithText)(i.engine.context,l.Zero(),7,U(t+200),"","#000000")),new F(new(0,O.BallsObject)(o.sum(l.Down(20)),5).setVelocity(r),new(0,X.CircleWithText)(i.engine.context,l.Zero(),7,U(t+100),"","#000000")),new F(new(0,O.BallsObject)(o.sum(l.Down(-20)),5).setVelocity(r),new(0,X.CircleWithText)(i.engine.context,l.Zero(),7,U(t),"","#000000")),new F(new(0,O.BallsObject)(o.sum(l.Right(-40)),5).setVelocity(r),new(0,X.CircleWithText)(i.engine.context,l.Zero(),7,U(t-100),"","#000000"))]}))},e.prototype.createBottomBouncyLine=function(){var t=new(0,G.ImmovableLineObject)(new l(0,this.engine.canvas.height-10),new l(this.engine.canvas.width,0));t.bounceValue=1.5,this.engine.addObject(new N(t,new D(this.engine.context,l.Zero(),l.Zero(),"#ff0000")))},e.prototype.createMilkShake=function(t){var e=this;Q.forEach((function(n){e.engine.addObject(new N(new(0,G.ImmovableLineObject)(n[0].sum(t.diff(new l(170,190))),n[1]),new D(e.engine.context,l.Zero(),l.Zero(),"#ffffff")))}))},e.prototype.initConstrain=function(){this.engine.constrain=new Y(this.engine.canvas.width,this.engine.canvas.height)},e.prototype.createActor=function(){this.actor=new F(new(0,R.ImmovableBallsObject)(new l(230,50),30),new(0,w.Circle)(this.engine.context,l.Zero(),30,"#ff0000")),this.engine.addObject(this.actor)},e.prototype.getActor=function(){return this.actor},e.prototype.tick=function(t){var e=this,n=this.generator.getNextObjects(t);n&&n.forEach((function(t){return e.engine.addObject(t)}))},e.prototype.processUserInput=function(t){var e=t;e.leftButtonDown?(this.actor.ballsObject.isPointInsideObject(new l(e.screenX,e.screenY))&&(this.canMoveRedObject=!0),this.canMoveRedObject&&this.actor.ballsObject.moveBy(new l(e.dx,e.dy))):this.canMoveRedObject=!1},e}(g),tt={};t(tt,"Scene2",(function(){return it}),(function(t){return it=t}));class et extends W{applyConstrain(t){const e=t.currentPosition.diff(this.center),n=e.length,i=t.radius||0;if(n>this.radius-i){const n=e.ort;t.moveTo(this.center.sum(n.mul(this.radius-i-1)))}}constructor(t,e){super(),y(this,"center",l.Zero()),y(this,"radius",0),this.center=t,this.radius=e}}var nt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),it=function(t){function e(e){var n=t.call(this,e)||this;return n._canMoveRedObject=!1,n.timePassedSinceLastBallCreated=0,n.ballIndex=0,n.center=new l(n.engine.canvas.width/2,n.engine.canvas.height/2),n.radius=Math.min(n.center.x,n.center.y),n.generator=new x(n.engine.solver),n.createActor(),n.initConstrain(),n}return nt(e,t),e.prototype.createBall=function(){new l(0,0);var t=this.actor.ballsObject.currentPosition,e=t.diff(this.center).ort,n=e.mul(-1),i=new F(new(0,O.BallsObject)(t.diff(e.mul(40)),5).setVelocity(n),new(0,X.CircleWithText)(this.engine.context,l.Zero(),7,U(this.ballIndex+200),"","#000000"));this.engine.addObject(i),this.ballIndex++},e.prototype.createActor=function(){this.actor=new F(new(0,R.ImmovableBallsObject)(new l(230,50),30),new(0,w.Circle)(this.engine.context,l.Zero(),30,"#ff0000")),this.engine.addObject(this.actor)},e.prototype.initConstrain=function(){this.engine.constrain=new et(this.center,this.radius),this.engine.items.push(new(0,w.Circle)(this.engine.context,this.center,this.radius,"#ffffff"))},e.prototype.getActor=function(){return this.actor},e.prototype.tick=function(t){this.canMoveRedObject&&(this.timePassedSinceLastBallCreated+=t,this.timePassedSinceLastBallCreated>.05&&(this.timePassedSinceLastBallCreated=0,this.createBall()))},e.prototype.processUserInput=function(t){var e=t;e.leftButtonDown?(this.actor.ballsObject.isPointInsideObject(new l(e.screenX,e.screenY))&&(this.canMoveRedObject=!0),this.canMoveRedObject):this.canMoveRedObject=!1,(e.screenX||e.screenY)&&this.actor.ballsObject.moveTo(new l(e.screenX,e.screenY))},Object.defineProperty(e.prototype,"canMoveRedObject",{get:function(){return this._canMoveRedObject},set:function(t){this._canMoveRedObject=t,this.actor.renderItem.color=t?"#00ff00":"#ff0000"},enumerable:!1,configurable:!0}),e}(g),ot={};t(ot,"Scene3",(function(){return vt}),(function(t){return vt=t}));var rt={};t(rt,"ImmovablePolygon",(function(){return ht}),(function(t){return ht=t}));var st={};t(st,"ImmovableSolverObject",(function(){return at}),(function(t){return at=t}));var ct=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),at=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ct(e,t),e}(M),ut=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),lt=function(t,e,n){if(n||2===arguments.length)for(var i,o=0,r=e.length;o<r;o++)!i&&o in e||(i||(i=Array.prototype.slice.call(e,0,o)),i[o]=e[o]);return t.concat(i||Array.prototype.slice.call(e))},ht=function(t){function e(e,n){var i=t.call(this)||this;return i._points=[],i._lines=[],i.type=C.TypeImmovablePolygon,i.immovable=!0,i.bounceValue=1,i.currentPosition=e.copy(),i.previousPosition=e.copy(),i._fixedPosition=e.copy(),n.forEach((function(t){return i._points.push(t.copy())})),i._recreateLines(),i}return ut(e,t),e.prototype._recreateLines=function(){var t,e=lt([],this._points,!0),n=e.shift(),i=n;for(this._lines.splice(0,this._lines.length);t=e.shift();)this._lines.push(new I(this._fixedPosition.sum(i),this._fixedPosition.sum(t))),i=t;this._lines.push(new I(this._fixedPosition.sum(i),this._fixedPosition.sum(n)))},e.prototype.update=function(t){this.currentPosition=this._fixedPosition,this.previousPosition=this._fixedPosition},e.prototype.addToGrid=function(t){var e=this;try{this._lines.forEach((function(n){t.addObjectToCells(n.vec1,n.vec2,e)}))}catch(t){console.log(t,this._lines)}},e.prototype.isPointInsideObject=function(t){return!0},e.prototype.moveBy=function(t){this.currentPosition.addSelf(t),this.previousPosition.addSelf(t),this._fixedPosition.addSelf(t),this._lines.forEach((function(e){return e.moveBy(t)}))},e.prototype.moveTo=function(t){this._fixedPosition=t.copy(),this.currentPosition=t.copy(),this.previousPosition=t.copy(),this._recreateLines()},Object.defineProperty(e.prototype,"lines",{get:function(){return this._lines},enumerable:!1,configurable:!0}),e}(st.ImmovableSolverObject),ft={};t(ft,"Polygon",(function(){return yt}),(function(t){return yt=t}));var pt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),yt=function(t){function e(e,n,i,o){var r=t.call(this,e,n)||this;return r.direction=l.Zero(),r.color="#00ff00",r.lines=i,o&&(r.color=o),r}return pt(e,t),e.prototype.render=function(){var t=this;this.context.strokeStyle=this.color,this.context.beginPath(),this.lines.forEach((function(e){t.context.moveTo(e.vec1.x,e.vec1.y),t.context.lineTo(e.vec2.x,e.vec2.y)})),this.context.stroke()},e}(d),dt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),vt=function(t){function e(e){var n=t.call(this,e)||this;return n._createBalls=!1,n.timePassedSinceLastBallCreated=0,n.ballIndex=0,n.ballsViews=[],n.center=new l(n.engine.canvas.width/2,n.engine.canvas.height/2),n.radius=Math.min(n.center.x,n.center.y),n.generator=new x(n.engine.solver),n.createActor(),n.initConstrain(),n}return dt(e,t),e.prototype.createBall=function(){new l(0,0);var t=this.actor.ballsObject.currentPosition,e=t.diff(this.center).ort,n=e.mul(-1),i=new(0,X.CircleWithText)(this.engine.context,l.Zero(),7,U(this.ballIndex+200),"","#000000");this.ballsViews.push(i);var o=new F(new(0,O.BallsObject)(t.diff(e.mul(40)),5).setVelocity(n),i);this.engine.addObject(o),this.ballIndex++},e.prototype.createActor=function(){var t,e,n,i=(e=(t=60)*Math.sqrt(3)/2,n=new l(t/2,t/2*(1/Math.sqrt(3))),[new l(-n.x,-n.y),new l(0,e-n.y),new l(n.x,-n.y)]),o=new(0,rt.ImmovablePolygon)(this.center,i),r=new(0,ft.Polygon)(this.engine.context,l.Zero(),o.lines,"#ff0000");this.actor=new F(o,r),this.engine.addObject(this.actor)},e.prototype.initConstrain=function(){this.engine.constrain=new et(this.center,this.radius),this.engine.items.push(new(0,w.Circle)(this.engine.context,this.center,this.radius,"#ffffff"))},e.prototype.getActor=function(){return this.actor},e.prototype.tick=function(t){this.createBalls&&(this.timePassedSinceLastBallCreated+=t,this.timePassedSinceLastBallCreated>.05&&(this.timePassedSinceLastBallCreated=0,this.createBall())),this.ballsViews.forEach((function(t){t.color=U(t.position.y)}))},e.prototype.processUserInput=function(t){var e=t;e.leftButtonDown?this.actor.ballsObject.isPointInsideObject(new l(e.screenX,e.screenY))&&(this.createBalls=!0):this.createBalls=!1,(e.screenX||e.screenY)&&this.actor.ballsObject.moveTo(new l(e.screenX,e.screenY))},Object.defineProperty(e.prototype,"createBalls",{get:function(){return this._createBalls},set:function(t){this._createBalls=t,this.actor.renderItem.color=t?"#00ff00":"#ff0000"},enumerable:!1,configurable:!0}),e}(g),bt={scene1:_.Scene1,scene2:tt.Scene2,scene3:ot.Scene3},_t=function(){function t(){this.tickData=[],this.totalData=[],this.keys=new Map}return t.prototype.resetTick=function(){var t=this;this.tickData.forEach((function(e,n){return t.tickData[n]=0}))},t.prototype.writeStats=function(t,e){var n=this.registerKey(t);this.tickData[n]=e,this.totalData[n]=e},t.prototype.addStats=function(t,e){var n=this.registerKey(t);this.tickData[n]+=e,this.totalData[n]+=e},t.prototype.registerKey=function(t){return this.keys.has(t)?this.keys.get(t):(this.tickData.push(0),this.totalData.push(0),this.keys.set(t,this.tickData.length-1),this.tickData.length-1)},t.prototype.getStats=function(t){if(!this.keys.has(t))return{key:t,total:0,tick:0};var e=this.keys.get(t);return{key:t,total:this.totalData[e],tick:this.tickData[e]}},t.prototype.getTickData=function(){var t=this,e=[];return this.keys.forEach((function(n,i){e.push({key:i,value:t.tickData[n]})})),e},t}(),gt=function(){function t(t){var e=this;this.objects=[],this._constrains=null,this.solver=null,this.flagRenderGrid=!1,this.flagRenderPreviousPosition=!1,this.nextFrame=function(t){e.step=t-e.timeRenderEnd,e.step<0&&(e.step=0),e.tick(),e.timeRenderEnd=t,self.requestAnimationFrame(e.nextFrame)},this.nextInterval=function(){e.timeRenderStart=performance.now(),e.step=e.timeRenderStart-e.timeRenderEnd,e.step<0&&(e.step=0),e.tick(),e.timeRenderEnd=performance.now()},this.stats=new _t,this.canvas=t,this.context=this.canvas.getContext("2d"),this.timeRenderStart=performance.now(),this.timeRenderEnd=performance.now(),this.step=0,this.objects=[],this.items=[],this.solver=null,this.configure()}return t.prototype.reset=function(){this.objects=[],this.items=[],this.solver.reset()},t.prototype.configure=function(){this.solver=new p(new l(this.canvas.width,this.canvas.height),this.stats),this.context.font="10px serif",this.loadScene("scene3")},t.prototype.processUserInput=function(t){var e=t;"g"===e.keyPressed&&(this.flagRenderGrid=!this.flagRenderGrid),"p"===e.keyPressed&&(this.flagRenderPreviousPosition=!this.flagRenderPreviousPosition),this.scene.processUserInput(t)},t.prototype.processEngineEvent=function(t){var e=t;e.scene&&this.loadScene(e.scene)},t.prototype.loadScene=function(t){this.reset();var e=bt[t];this.scene=new e(this)},t.prototype.addObject=function(t){this.objects.push(t),this.solver.addObject(t.ballsObject)},t.prototype.update=function(t){this.solver.update(t)},t.prototype.tick=function(){this.step<0&&(this.step=0);var t=this.step/1e3;this.scene.tick(t),this.update(t),this.clear(),this.renderItems(),this.flagRenderGrid&&this.renderGrid(),this.flagRenderPreviousPosition&&this.renderPreviousPosition(),this.printFPS(),this.stats.resetTick(),l.lengthCallsCount=0,l.length2CallsCount=0},t.prototype.renderItems=function(){this.items.forEach((function(t){return t.render()})),this.objects.forEach((function(t){return t.render()}))},t.prototype.printText=function(t,e,n){this.context.fillStyle="#ffffff",this.context.textAlign="start",this.context.fillText(t,e,n)},t.prototype.printFPS=function(){var t=this;this.context.fillStyle="rgba(0,0,0,0.1)",this.context.fillRect(0,0,100,60),this.printText("".concat(Math.round(this.step)," ms / ").concat(Math.round(1e3/this.step)," FPS"),0,10),this.printText("Length calls: ".concat(l.lengthCallsCount),0,20),this.printText("Lenght2 calls: ".concat(l.length2CallsCount),0,30),this.printText("Objects: ".concat(this.objects.length),0,40),this.printText("Compares per object: ".concat(Math.round(l.lengthCallsCount/this.objects.length)),0,50),this.stats.getTickData().forEach((function(e,n){t.printText("".concat(e.key,": ").concat(e.value),0,10*n+60)}))},t.prototype.clear=function(){this.context.fillStyle="rgba(0, 0, 0, 0.9)",this.context.fillRect(0,0,this.canvas.width,this.canvas.height)},t.prototype.start=function(){self.requestAnimationFrame?self.requestAnimationFrame(this.nextFrame):setInterval(this.nextInterval,16)},t.prototype.renderGrid=function(){var t=this;this.solver.collisionGrid.forEach((function(e,n,i,o){var r=new l(e*t.solver.cellSize.x,n*t.solver.cellSize.y),s=new b(t.context,r,t.solver.cellSize.diff(new l(5,5)),i.count>0?"#ff0000":"#00ff00");i.highlight&&(t.context.lineWidth=10),s.render(),t.context.lineWidth=1,t.printText(o,r.x+t.solver.cellSize.x/2,r.y+t.solver.cellSize.y/2)}))},t.prototype.renderPreviousPosition=function(){var t=this;this.objects.forEach((function(e){var n=e.ballsObject.previousPosition;t.context.fillStyle="rgba(0, 0, 255, 0.5)",t.context.beginPath(),t.context.arc(n.x,n.y,10,0,2*Math.PI),t.context.fill()}))},Object.defineProperty(t.prototype,"constrain",{get:function(){return this._constrains},set:function(t){this._constrains=t,this.solver.constrains=this._constrains},enumerable:!1,configurable:!0}),t}(),xt={};t(xt,"MessageType",(function(){return mt}),(function(t){return mt=t}));var mt,wt,jt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();(wt=mt||(mt={}))[wt.MessageNone=0]="MessageNone",wt[wt.MessageInit=1]="MessageInit",wt[wt.MessageUserInput=2]="MessageUserInput",wt[wt.MessageEngineEvent=3]="MessageEngineEvent";var Pt,Ot=function(){this.type=mt.MessageNone};(function(t){function e(e){var n=t.call(this)||this;return n.type=mt.MessageInit,n.canvas=e,n}jt(e,t)})(Ot),function(t){function e(e){var n=t.call(this)||this;return n.type=mt.MessageUserInput,n.event=e,n}jt(e,t)}(Ot),function(t){function e(e){var n=t.call(this)||this;return n.type=mt.MessageEngineEvent,n.event=e,n}jt(e,t)}(Ot);onmessage=function(t){switch(t.data.type){case xt.MessageType.MessageInit:(Pt=new gt(t.data.canvas)).start();break;case xt.MessageType.MessageUserInput:Pt&&Pt.processUserInput(t.data.event);break;case xt.MessageType.MessageEngineEvent:Pt&&Pt.processEngineEvent(t.data.event)}}}();