!function(){class t extends Error{}class e extends t{}class s extends t{}class i extends t{}class n{static diff(t,e){return new r(t.x-e.x,t.y-e.y)}static mul(t,e){return new r(t.x*e,t.y*e)}static distance(t,e){return n.diff(t,e).length}static distance2(t,e){return n.diff(t,e).length2}static intersect(t,s){if(t.K===s.K)throw new e;if(isNaN(t.K)||isNaN(s.K))return isNaN(t.K)?s.makeVec2FromX(t._vec1.x):t.makeVec2FromX(s._vec1.x);{const e=(t.B-s.B)/(s.K-t.K);return t.makeVec2FromX(e)}}static dot(t,e){return t.x*e.x+t.y*e.y}static mirror(t,e){const s=e.direction.perpendicular;return t.diff(s.mul(2*n.dot(t,s)))}static scale(t,e){return new r(t.x/e.x,t.y/e.y)}}const o=1e-6,h=Math.sqrt(2);class r{get x(){return this._x}get y(){return this._y}set x(t){this._x=t,this.reset()}set y(t){this._y=t,this.reset()}get length(){return null===this._length&&(this._length=Math.sqrt(this.x*this.x+this.y*this.y),r.lengthCallsCount++),this._length}get length2(){return null===this._length2&&(this._length2=this._x*this._x+this._y*this._y,r.length2CallsCount++),this._length2}moveTo(t,e){t instanceof r?(this._x=t.x,this._y=t.y):(this._x=t,this._y=e),this.reset()}reset(){this._length=null,this._length2=null}addSelf(t){return this._x+=t.x,this._y+=t.y,this._length=null,this}moveBy(t){this.addSelf(t)}subSelf(t){return this._x-=t.x,this._y-=t.y,this._length=null,this}flipYSelf(){return this._y=-this._y,this}flipXSelf(){return this._x=-this._x,this}flipSelf(){return this._x=-this._x,this._y=-this._y,this}equals(t){return n.distance2(this,t)<1e-12}sum(t){return new r(this.x+t.x,this.y+t.y)}diff(t){return new r(this.x-t.x,this.y-t.y)}mul(t){return new r(this.x*t,this.y*t)}dot(t){return this.x*t.x+this.y*t.y}copy(){return new r(this.x,this.y)}applySelf(t){return this.x=t(this.x),this.y=t(this.y),this}isInsideRect(t,e){const s=Math.min(t.x,e.x),i=Math.min(t.y,e.y),n=Math.max(t.x,e.x),o=Math.max(t.y,e.y);return this._x>=s&&this._x<=n&&this._y>=i&&this._y<=o}get ort(){const t=this.length;return new r(this.x/t,this.y/t,1)}get abs(){return new r(Math.abs(this.x),Math.abs(this.y))}get perpendicular(){if(0===this.x){if(this.y>0)return r.Horizontal().ort;if(this.y<0)return r.Horizontal().ort.flipSelf();throw new s}if(0===this.y){if(this.x>0)return r.Vertical().ort;if(this.x<0)return r.Vertical().ort.flipSelf()}return new r(-this.y,this.x).ort}static Zero(){return new r(0,0)}static Horizontal(){return new r(1,0)}static Vertical(){return new r(0,1)}static Down(t){return new r(0,t)}static Right(t){return new r(t,0)}constructor(t,e,s){this._x=0,this._y=0,this._length=null,this._length2=null,this._x=t,this._y=void 0===e?t:e,s&&(this._length=s,this._length2=s*s)}}r.lengthCallsCount=0,r.length2CallsCount=0;class c{}class a{addObject(t){this.objects.length>=a.MAX_OBJECT_IN_CELL||this.objects.push(t)}clear(){this.objects=[],this.highlight=!1}remove(t){const e=this.objects.findIndex((e=>e.index===t));-1!==e&&this.objects.splice(e,1)}get count(){return this.objects.length}constructor(){this.objects=[],this.highlight=!1}}a.MAX_OBJECT_IN_CELL=100;class l extends c{get size(){return this._size}get width(){return this._width}set width(t){this._width=t,this.resize()}get height(){return this._height}set height(t){this._height=t,this.resize()}recalculateIndex2xy(){this.index2xy=[];for(let t=0;t<this._size;t++)this.index2xy.push(this.makeVecFromIndex(t))}recalculateCollisionCells(){this.adjacentCells=[],this.cells.forEach(((t,e)=>{const s=this.getVecFromIndex(e),i=[];i.push(t),s.y>0&&i.push(this.cells[this.makeIndexFromCoord(s.x,s.y-1)]),s.y+1<this._height&&i.push(this.cells[this.makeIndexFromCoord(s.x,s.y+1)]),s.x>0&&(s.y>0&&i.push(this.cells[this.makeIndexFromCoord(s.x-1,s.y-1)]),i.push(this.cells[this.makeIndexFromCoord(s.x-1,s.y)]),s.y+1<this._height&&i.push(this.cells[this.makeIndexFromCoord(s.x-1,s.y+1)])),s.x+1<this._width&&(s.y>0&&i.push(this.cells[this.makeIndexFromCoord(s.x+1,s.y-1)]),i.push(this.cells[this.makeIndexFromCoord(s.x+1,s.y)]),s.y+1<this._height&&i.push(this.cells[this.makeIndexFromCoord(s.x+1,s.y+1)])),this.adjacentCells[e]=i}))}getVecFromIndex(t){return this.index2xy[t]}resize(){this.cells=[],this._size=this._width*this._height;for(let t=0;t<this._size;t++)this.cells.push(new a);this.recalculateIndex2xy(),this.recalculateCollisionCells()}addObject(t){this.addObjectByIndex(0,t)}addPointObject(t,e,s){const i=Math.trunc(t/this.cellSize.x),n=Math.trunc(e/this.cellSize.y),o=this.makeIndexFromCoord(i,n);this.addObjectByIndex(o,s)}addObjectByIndex(t,e){!isNaN(t)&&t>=0&&t<this.size&&this.cells[t].addObject(e)}makeIndexFromVec(t){return t.x*this._height+t.y}makeIndexFromCoord(t,e){return t*this._height+e}makeVecFromIndex(t){const e=Math.trunc(t/this._height),s=t-e*this._height;return new r(e,s)}addRectangularObject(t,e,s){const i=n.scale(t,this.cellSize).applySelf(Math.trunc),o=n.scale(e,this.cellSize).applySelf(Math.trunc);let h=Math.max(Math.min(i.x,o.x),0),r=Math.max(Math.min(i.y,o.y),0),c=Math.min(Math.max(i.x,o.x),this._width-1),a=Math.min(Math.max(i.y,o.y),this._height-1);const l=this.makeIndexFromCoord(h,r),d=this.makeIndexFromCoord(c,a);if(!(c>=this._width||h<0||r<0||a>=this._height))if(i.x===o.x)for(let t=l;t<=d;t++)this.cells[t].addObject(s);else if(i.y===o.y)for(let t=l;t<=d;t+=this.height)this.cells[t].addObject(s);else{let t=a-r,e=this.makeIndexFromCoord(h,r);for(let i=0;i<=c-h;i++)for(let n=0;n<=t;n++){const t=e+this.makeIndexFromCoord(i,n);this.addObjectByIndex(t,s)}}}clear(){this.cells.forEach((t=>t.clear()))}forEach(t){this.cells.forEach(((e,s)=>{const i=this.getVecFromIndex(s);t(i.x,i.y,e,s)}))}hasCell(t,e){if(t<0||t>=this.size)return!1;const s=this.getVecFromIndex(t),i=s.x,n=s.y;return!(n<=0&&e<0)&&(!(n===this.height-1&&e>0)&&(!(0===i&&e<0)&&!(i>=this.width-1&&e>0)))}debugRender(t){this.forEach(((e,s,i,n)=>{const o=new r(e*this.cellSize.x,s*this.cellSize.y);t.strokeStyle(i.count>0?"#ff0000":"#00ff00"),t.lineWidth(i.highlight?10:1),t.rect(o.x,o.y,this.cellSize.x-1,this.cellSize.y-1),t.fillStyle("#ffffff"),t.text(`${n}`,o.sum(this.cellSize.mul(.5)))}))}constructor(t,e,s){super(),this.cells=[],this.index2xy=[],this.adjacentCells=[],this._width=t,this._height=e,this.cellSize=s,this.resize()}}class d{reset(){this.objects=[]}configure(){this.useFixedTime=!0,this.step=.017/this.subSteps}addObject(t){this.objects.push(t)}update(t){const e=this.useFixedTime?this.step:t/this.subSteps;for(let t=0;t<this.subSteps;t++)this.processOptimizations(),this.processCollisions(),this.applyForces(),this.updateObjects(e),this.applyConstrains()}updateObjects(t){this.objects.forEach((e=>e.update(t)))}applyConstrains(){this.objects.forEach((t=>this.constrains.applyConstrain(t)))}constructor(t,e){this.objects=[],this.constrains=null,this.subSteps=4,this.useFixedTime=!0,this.stats=e,this.objects=[],this.worldSize=t.copy(),this.configure()}}class u extends d{reset(){super.reset(),this.collisionGrid.clear()}configure(){super.configure(),this.gravity=new r(0,100),this.gravityCenter=new r(this.worldSize.x/2,this.worldSize.y/2);const t=Math.round(this.worldSize.x/16),e=Math.round(this.worldSize.y/16);this.cellSize=new r(this.worldSize.x/t,this.worldSize.y/e),this.collisionGrid=new l(t,e,this.cellSize)}processOptimizations(){this.collisionGrid.clear(),this.objects.forEach(((t,e)=>{t.addToSpace(this.collisionGrid),this.stats.addStats(`Solver object: ${t.toString()}`)}))}applyForces(){this.objects.forEach((t=>{const e=n.diff(t.currentPosition,this.gravityCenter);t.accelerate(e.ort.mul(-this.gravity.length))}))}processCollisionsInCell(t,e){this.stats.addStats("processCollisionsInCell.calls"),e.objects.forEach((e=>{t!==e&&(t.immovable&&e.immovable||(this.stats.addStats("processCollisions.calls"),t.collide(e)))}))}processCell(t){this.stats.addStats("processCell.calls",1);const e=this.collisionGrid.cells[t];e.objects.forEach((s=>{this.collisionGrid.adjacentCells[t].forEach((t=>{t===e&&1===t.objects.length||this.processCollisionsInCell(s,t)}))}))}processCollisions(){for(let t=0;t<this.collisionGrid.size;t++)this.processCell(t)}debugRender(t){this.collisionGrid.debugRender(t),this.objects.forEach((e=>e.debugRender(t)))}constructor(t,e){super(t,e),this.gravity=r.Zero(),this.gravityCenter=r.Zero(),this.configure()}}class g{constructor(t){this.engine=t}}class y{getNextObjects(t){return[]}constructor(t){this.solver=null,this.solver=t}}class f extends y{getNextObjects(t){if(this.total>this.limit)return[];if(this.lastCreateTime+=1,this.lastCreateTime>this.delay){const t=this.create(this.total);return this.lastCreateTime=0,this.total+=t.length,t}return[]}constructor(t,e,s,i){super(t),this.limit=e,this.total=0,this.delay=s,this.create=i,this.lastCreateTime=0}}class p{render(){}queue(){}constructor(t,e){this.position=r.Zero(),this.renderer=t,this.position=e}}class x extends p{render(){this.renderer.strokeStyle(this.color),this.renderer.fillStyle(this.color),this.renderer.fillCircle(this.r,this.position)}constructor(t,e,s,i){super(t,e),this.r=0,this.color="#00ff00",s&&(this.r=s),i&&(this.color=i)}}class m{inBetween(t){const e=n.diff(t,this._vec1).length+n.diff(this._vec2,t).length;return s=this._length,i=e,h=o,Math.abs(s-i)<h;var s,i,h}inBetweenFast(t){return t.isInsideRect(this._vec1,this._vec2)}calculateKB(){this._vec1.y===this._vec2.y?(this._b=this._vec1.y,this._k=0):this._vec1.x===this._vec2.x?(this._b=NaN,this._k=NaN):(this._b=(this._vec1.x*this._vec2.y-this._vec1.y*this._vec2.x)/(this._vec1.x-this._vec2.x),this._k=(this._vec1.y-this._vec2.y)/(this._vec1.x-this._vec2.x))}makeVec2FromX(t){return new r(t,this._k*t+this._b)}copy(){return new m(this._vec1,this._vec2)}moveBy(t){return this._vec1.addSelf(t),this._vec2.addSelf(t),this.calculateKB(),this}getPointProjection(t){const e=this.direction,s=n.diff(t,this._vec1),i=n.dot(e,s)/this.length;return this._vec1.sum(this.ort.mul(i))}get B(){return this._b}get K(){return this._k}get length(){return this._length}get direction(){return this._direction}get ort(){return this._ort}get vec1(){return this._vec1}get vec2(){return this._vec2}get normal(){return this._vec2.diff(this._vec1).perpendicular}static Vertical(t){return new m(new r(t,0),new r(t,Number.MAX_SAFE_INTEGER))}static Horizontal(t){return new m(new r(0,t),new r(Number.MAX_SAFE_INTEGER,t))}constructor(t,e){this._vec1=r.Zero(),this._vec2=r.Zero(),this._k=0,this._b=0,this._vec1=t.copy(),this._vec2=e.copy(),this._direction=n.diff(this._vec1,this._vec2),this._length=this._direction.length,this._length2=this._direction.length2,this._ort=this._direction.ort,this.calculateKB()}}var _,v;function b(t,e,s){try{const i=e.getPointProjection(t.currentPosition);if(e.inBetweenFast(i)){const o=n.diff(i,t.currentPosition);if(o.length2<t.radius2){const i=o.ort,h=(i.dot(e.normal)>0?1:-1)*(t.radius-o.length);t.moveBy(n.mul(i,-h*t.bounceValue*s))}}}catch(t){}}function w(t,e){let s=t,i=e;if(s.type>i.type){const t=function(t,e){return{a:e,b:t}}(s,i);s=t.a,i=t.b}switch(!0){case s.type===_.TypeBall&&i.type===_.TypeBall:return function(t,e){if(!t.getBoundary().intersect(e.getBoundary()))return;const s=n.diff(t.currentPosition,e.currentPosition),i=s.length,o=t.radius+e.radius;if(i<o){const h=s.ort,r=o-i;t.moveBy(n.mul(h,t.radius/o*r*t.bounceValue)),e.moveBy(n.mul(h,-e.radius/o*r*e.bounceValue))}}(s,i);case s.type===_.TypeBall&&i.type===_.TypeImmovableBall:return function(t,e){if(!t.getBoundary().intersect(e.getBoundary()))return;const s=n.diff(t.currentPosition,e.currentPosition),i=s.length,o=t.radius+e.radius;if(i<o){const h=s.ort,r=o-i;t.moveBy(n.mul(h,t.radius/o*r*t.bounceValue*e.bounceValue))}}(s,i);case s.type===_.TypeBall&&i.type===_.TypeImmovableLine:return h=i,void((o=s).getBoundary().intersect(h.getCollisionRange())&&b(o,h._line,h.bounceValue));case s.type===_.TypeBall&&i.type===_.TypeImmovablePolygon:return function(t,e){t.getBoundary().intersect(e.getCollisionRange())&&e.lines.forEach((e=>b(t,e._line,e.bounceValue)))}(s,i);default:return}var o,h}(v=_||(_={}))[v.TypeNull=0]="TypeNull",v[v.TypeBall=1]="TypeBall",v[v.TypeImmovableBall=2]="TypeImmovableBall",v[v.TypeImmovableLine=3]="TypeImmovableLine",v[v.TypeImmovablePolygon=4]="TypeImmovablePolygon";class P{update(t){}accelerate(t){}collide(t){}inside(t){return this.currentPosition.x>=t.left&&this.currentPosition.x<=t.right&&this.currentPosition.y>=t.top&&this.currentPosition.y<=t.bottom}debugRender(t){}toString(){return"BaseSolverObject"}constructor(){this.type=_.TypeNull,this.previousPosition=r.Zero(),this.currentPosition=r.Zero(),P.index+=1,this.index=P.index}}P.index=0;class S{recalculate(){this._width2=this.size.x/2,this._height2=this.size.y/2,this._left=this.position.x-this._width2,this._right=this.position.x+this._width2,this._top=this.position.y-this._height2,this._bottom=this.position.y+this._height2}copy(){return new S(this.position,this.size)}intersect(t){return!(this.left>t.right||this.right<t.left||this.top>t.bottom||this.bottom<t.top)}contains(t){return t.x>this.left&&t.x<this.right&&t.y>this.top&&t.y<this.bottom}moveBy(t){this.position.addSelf(t),this.recalculate()}moveTo(t){this.position=t.copy(),this.recalculate()}get nw(){return new S(new r(this.position.x-this._width2/2,this.position.y-this._height2/2),new r(this._width2,this._height2))}get ne(){return new S(new r(this.position.x+this._width2/2,this.position.y-this._height2/2),new r(this._width2,this._height2))}get se(){return new S(new r(this.position.x+this._width2/2,this.position.y+this._height2/2),new r(this._width2,this._height2))}get sw(){return new S(new r(this.position.x-this._width2/2,this.position.y+this._height2/2),new r(this._width2,this._height2))}get left(){return this._left}get right(){return this._right}get top(){return this._top}get bottom(){return this._bottom}get diag(){return this.size.length}get width(){return this.size.x}get height(){return this.size.y}constructor(t,e){if(this.position=t.copy(),this.size=e.copy(),this.size.x<0||this.size.y<0)throw new i;this.recalculate()}}const j=Math.pow(10,2);class C extends P{update(t){let e=this.velocity.mul(this.motionReduce);e.length2>j&&(e=e.ort.mul(10)),this.previousPosition=this.currentPosition.copy(),this.moveBy(e.addSelf(this.acc.mul(t*t))),this.acc=r.Zero()}accelerate(t){return this.acc.addSelf(t),this}setVelocity(t){return this.velocity=t,this}collide(t){w(this,t)}addToSpace(t){t.addPointObject(Math.floor(this.currentPosition.x),Math.floor(this.currentPosition.y),this)}moveBy(t){this.currentPosition.moveBy(t),this.collisionRange.moveBy(t),this.boundary.moveBy(t)}moveTo(t){this.currentPosition.moveTo(t),this.collisionRange.moveTo(this.currentPosition),this.boundary.moveTo(this.currentPosition)}isPointInsideObject(t){return n.distance(this.currentPosition,t)<this.radius}get velocity(){return n.diff(this.currentPosition,this.previousPosition)}set velocity(t){this.previousPosition=n.diff(this.currentPosition,t)}get movementVector(){return new m(this.previousPosition,this.currentPosition)}get radius2(){return this._radius2}intersects(t){return new S(this.currentPosition,new r(this.radius,this.radius)).intersect(t)}getCollisionRange(){return this.collisionRange}getBoundary(){return this.boundary}debugRender(t){t.strokeStyle("#FF0000");const e=this.getCollisionRange();t.rect(e.left,e.top,e.width,e.height)}constructor(t,e){super(),this.acc=r.Zero(),this.radius=10,this.bounceValue=1.1,this.motionReduce=.999,this.type=_.TypeBall,this.immovable=!1,this.previousPosition=t.copy(),this.currentPosition=t.copy(),void 0!==e&&(this.radius=e),this._radius2=this.radius*this.radius,this.collisionRange=new S(this.currentPosition,new r(4*this.radius)),this.boundary=new S(this.currentPosition,new r(2*this.radius))}}class R{update(){this.renderItem.position=this.solverObject.currentPosition}render(){this.update(),this.renderItem.render()}constructor(t,e){this.solverObject=null,this.renderItem=null,this.solverObject=t,this.renderItem=e}}class k extends C{update(t){this.currentPosition=this._fixedPosition,this.previousPosition=this._fixedPosition,this.collisionRange.moveTo(this.currentPosition)}addToSpace(t){const e=new r(this.radius*h,this.radius*h),s=this.currentPosition.sum(e),i=this.currentPosition.diff(e);t.addRectangularObject(s,i,this)}moveTo(t){this.currentPosition=t.copy(),this.previousPosition=t.copy(),this._fixedPosition=t.copy(),super.moveTo(t)}constructor(t,e){super(t,e),this.type=_.TypeImmovableBall,this.immovable=!0,this.bounceValue=.5,this._fixedPosition=null,this._fixedPosition=t.copy()}}class I extends R{update(){super.update(),this.renderItem.direction=this.solverObject._direction}constructor(t,e){var s,i,n;super(t),n=null,(i="solverObject")in(s=this)?Object.defineProperty(s,i,{value:n,enumerable:!0,configurable:!0,writable:!0}):s[i]=n,this.solverObject=t,this.renderItem=e}}class B extends P{}class T extends B{update(t){this.currentPosition=this._line.vec1,this.previousPosition=this._line.vec2}addToSpace(t){t.addRectangularObject(this._line.vec1,this._line.vec2,this)}moveBy(t){this.currentPosition.addSelf(t),this.previousPosition.addSelf(t),this._line.moveBy(t),this.collisionRange=new S(this.currentPosition.sum(this._direction.mul(.5)),this._direction.abs)}moveTo(t){const e=n.diff(t,this._line.vec1);this.moveBy(e)}debugRender(t){t.strokeStyle("#00FF00"),t.line(this._line.vec1,this._line.vec2),t.text(`${this.index}`,this._line.vec1),t.strokeStyle("#FFFFFF"),t.lineWidth(10);const e=this.currentPosition.sum(this._line.normal.flipSelf().mul(100));t.line(this.currentPosition.x,this.currentPosition.y,e.x,e.y),t.lineWidth(1),t.strokeStyle("#FF0000"),t.rect(this.collisionRange.left,this.collisionRange.top,this.collisionRange.width,this.collisionRange.height)}toString(){return"ImmovableLine"}inside(t){return t.intersect(this.collisionRange)}intersects(t){return!!t.intersect(this.collisionRange)&&(!(!t.contains(this._line.vec1)&&!t.contains(this._line.vec2))||(this.collisionRange.top<t.top&&this.collisionRange.bottom>t.top||(this.collisionRange.top<t.bottom&&this.collisionRange.bottom>t.bottom||(this.collisionRange.left<t.left&&this.collisionRange.right>t.left||(this.collisionRange.left<t.right&&this.collisionRange.right>t.right||void 0)))))}isPointInsideObject(t){return!1}getCollisionRange(){return this.collisionRange}constructor(t,e){super(),this.type=_.TypeImmovableLine,this.immovable=!0,this.bounceValue=1,t instanceof m?(this.currentPosition=t.vec1.copy(),this.previousPosition=t.vec1.copy(),this._direction=t.direction.copy().flipSelf()):(this.currentPosition=t.copy(),this.previousPosition=t.copy(),this._direction=e),this._line=new m(this.currentPosition.copy(),this.currentPosition.copy().sum(this._direction)),this.collisionRange=new S(this.currentPosition.sum(this._direction.mul(.5)),this._direction.abs)}}function O(t,e){return new T(t,n.diff(e,t))}class M extends p{render(){this.renderer.strokeStyle(this.color),this.renderer.vector(this.position,this.direction)}constructor(t,e,s,i){super(t,e),this.direction=r.Zero(),this.color="#00ff00",this.direction=s,i&&(this.color=i)}}class E extends x{render(){super.render(),""!==this.text&&(this.renderer.fillStyle(this.textColor),this.renderer.text(this.text,this.position))}constructor(t,e,s,i,n,o){super(t,e,s,i),this.text="",this.textColor="#ffffff",this.text=n,o&&(this.textColor=o)}}function F(t){const e=.005;return`rgba(${Math.floor(127*Math.sin(e*t+0)+128)}, ${Math.floor(127*Math.sin(e*t+2)+128)}, ${Math.floor(127*Math.sin(e*t+4)+128)}, 1)`}class z{constructor(){}}class V extends z{get width(){return this._width}set width(t){this._width=t}get height(){return this._height}set height(t){this._height=t}applyConstrain(t){const e=t.currentPosition.copy();let s=!1;t.currentPosition.x-t.radius<0?(e.x=t.radius,s=!0):t.currentPosition.x+t.radius>this._width&&(e.x=this._width-t.radius,s=!0),t.currentPosition.y-t.radius<0?(e.y=t.radius,s=!0):t.currentPosition.y+t.radius>this._height&&(e.y=this._height-t.radius,s=!0),s&&t.moveTo(e)}constructor(t,e){super(),this._width=0,this._height=0,this.width=t,this.height=e}}const N=[new r(0,0),new r(70,380),new r(270,380),new r(340,0),new r(360,0),new r(280,400),new r(60,400),new r(-20,0)];function Z(t,e){const s=e.diff(new r(180*t,200*t)),i=[];for(let e=0;e<N.length-1;e++)i.push(new m(N[e].mul(t).sum(s),N[e+1].mul(t).sum(s)));return i.push(new m(N[N.length-1].mul(t).sum(s),N[0].mul(t).sum(s))),i}class D extends z{applyConstrain(t){const e=t.currentPosition.diff(this.center),s=e.length,i=t.radius||0;if(s>this.radius-i){const s=e.ort;t.moveTo(this.center.sum(s.mul(this.radius-i)))}}constructor(t,e){super(),this.center=r.Zero(),this.radius=0,this.center=t,this.radius=e}}function L(t){const e=t*Math.sqrt(3)/2,s=new r(t/2,t/2*(1/Math.sqrt(3)));return[new r(-s.x,-s.y),new r(0,e-s.y),new r(s.x,-s.y)]}class A extends B{_recreateLines(){const t=[...this._localPoints].reverse();let e,s=t.shift(),i=s;for(this._lines.splice(0,this._lines.length);e=t.shift();){const t=O(this._fixedPosition.sum(i),this._fixedPosition.sum(e));this._lines.push(t),i=e}const n=O(this._fixedPosition.sum(i),this._fixedPosition.sum(s));this._lines.push(n)}update(t){this.currentPosition=this._fixedPosition,this.previousPosition=this._fixedPosition}addToSpace(t){try{this._lines.forEach((e=>e.addToSpace(t)))}catch(t){console.log(t,this._lines)}}isPointInsideObject(t){return!0}moveBy(t){this._fixedPosition.addSelf(t),this._lines.forEach((e=>e.moveBy(t)))}moveTo(t){const e=n.diff(t,this._fixedPosition);this.moveBy(e)}toString(){return"ImmovablePolygon"}debugRender(t){t.strokeStyle("#00FF00"),this._lines.forEach((e=>e.debugRender(t)))}get lines(){return this._lines}intersects(t){return this._lines.some((e=>e.intersects(t)))}getCollisionRange(){return new S(this.currentPosition,new r(60,60))}constructor(t,e){super(),this._localPoints=[],this._lines=[],this.type=_.TypeImmovablePolygon,this.immovable=!0,this.bounceValue=1,this.currentPosition=t.copy(),this.previousPosition=t.copy(),this._fixedPosition=t.copy(),e.forEach((t=>{this._localPoints.push(t.copy())})),this._recreateLines()}}class G extends p{render(){this.renderer.strokeStyle(this.color),this.renderer.polygon(this.points.map((t=>t.sum(this.position))))}constructor(t,e,s,i){super(t,e),this.direction=r.Zero(),this.color="#00ff00",this.points=s,i&&(this.color=i)}}class X extends G{}const $={scene1:class extends g{createBallsGenerator(t,e,s){const i=t.diff(e),n=s.mul(1/this.engine.solver.subSteps);return new f(this.engine.solver,1e3,7,(t=>[new R(new C(i,5).setVelocity(n),new E(this.engine.context,r.Zero(),5,F(t+200),"","#000000")),new R(new C(i.sum(r.Down(20)),5).setVelocity(n),new E(this.engine.context,r.Zero(),5,F(t+100),"","#000000")),new R(new C(i.sum(r.Down(-20)),5).setVelocity(n),new E(this.engine.context,r.Zero(),5,F(t),"","#000000")),new R(new C(i.sum(r.Right(-40)),5).setVelocity(n),new E(this.engine.context,r.Zero(),5,F(t-100),"","#000000"))]))}createBottomBouncyLine(){const t=new T(new r(0,this.engine.canvas.height-10),new r(this.engine.canvas.width,0));t.bounceValue=1.5,this.engine.addObject(new I(t,new M(this.engine.context,r.Zero(),r.Zero(),"#ff0000")))}createMilkShake(t){Z(1,t).forEach((t=>{this.engine.addObject(new I(new T(t),new M(this.engine.context,r.Zero(),r.Zero(),"#ffffff")))})),Z(.5,t).forEach((t=>{this.engine.addObject(new I(new T(t),new M(this.engine.context,r.Zero(),r.Zero(),"#0000ff")))}))}initConstrain(){this.engine.constrain=new V(this.engine.canvas.width,this.engine.canvas.height)}createActor(){this.actor=new R(new k(new r(230,50),30),new x(this.engine.context,r.Zero(),30,"#ff0000")),this.engine.addObject(this.actor)}getActor(){return this.actor}tick(t){if(this.engine.stats.addStats("Time passed",t),t>.017)return;const e=this.generator.getNextObjects(t);e&&e.forEach((t=>this.engine.addObject(t)))}processUserInput(t){const e=t;e.leftButtonDown?(this.actor.solverObject.isPointInsideObject(new r(e.screenX,e.screenY))&&(this.canMoveRedObject=!0),this.canMoveRedObject&&this.actor.solverObject.moveBy(new r(e.dx,e.dy))):this.canMoveRedObject=!1}constructor(t){super(t),this.canMoveRedObject=!1;const e=new r(this.engine.canvas.width/2,this.engine.canvas.height/2);this.generator=this.createBallsGenerator(e,new r(300,300),new r(2,-2)),this.createBottomBouncyLine(),this.createMilkShake(e),this.createActor(),this.initConstrain()}},scene2:class extends g{createBall(){new r(0,0);const t=this.actor.solverObject.currentPosition,e=t.diff(this.center).ort,s=e.mul(-1),i=new R(new C(t.diff(e.mul(40)),5).setVelocity(s),new E(this.engine.context,r.Zero(),7,F(this.ballIndex+200),"","#000000"));this.engine.addObject(i),this.ballIndex++}createActor(){this.actor=new R(new k(new r(230,50),30),new x(this.engine.context,r.Zero(),30,"#ff0000")),this.engine.addObject(this.actor)}initConstrain(){this.engine.constrain=new D(this.center,this.radius),this.engine.items.push(new x(this.engine.context,this.center,this.radius,"#ffffff"))}getActor(){return this.actor}tick(t){this.canMoveRedObject&&(this.timePassedSinceLastBallCreated+=t,this.timePassedSinceLastBallCreated>.05&&(this.timePassedSinceLastBallCreated=0,this.createBall()))}processUserInput(t){const e=t;e.leftButtonDown?(this.actor.solverObject.isPointInsideObject(new r(e.screenX,e.screenY))&&(this.canMoveRedObject=!0),this.canMoveRedObject):this.canMoveRedObject=!1,(e.screenX||e.screenY)&&this.actor.solverObject.moveTo(new r(e.screenX,e.screenY))}set canMoveRedObject(t){this._canMoveRedObject=t,this.actor.renderItem.color=t?"#00ff00":"#ff0000"}get canMoveRedObject(){return this._canMoveRedObject}constructor(t){super(t),this._canMoveRedObject=!1,this.timePassedSinceLastBallCreated=0,this.ballIndex=0,this.center=new r(this.engine.canvas.width/2,this.engine.canvas.height/2),this.radius=Math.min(this.center.x,this.center.y),this.generator=new y(this.engine.solver),this.createActor(),this.initConstrain()}},scene3:class extends g{createBall(){new r(0,0);const t=this.actor.solverObject.currentPosition,e=t.diff(this.center).ort,s=e.mul(-1),i=20+30*Math.random(),n=new E(this.engine.context,r.Zero(),i,F(this.ballIndex+200),"","#000000");this.ballsViews.push(n);const o=new R(new C(t.diff(e.mul(40)),i).setVelocity(s),n);this.engine.addObject(o),this.ballIndex++}createActor(){const t=L(60);this.nextTickActorPosition=this.center;const e=new A(this.center,t),s=new X(this.engine.context,r.Zero(),t,"#ff0000");this.actor=new R(e,s),this.engine.addObject(this.actor)}initConstrain(){this.engine.constrain=new D(this.center,this.radius),this.engine.items.push(new x(this.engine.context,this.center,this.radius,"#555555"))}getActor(){return this.actor}tick(t){this.actor.solverObject.moveTo(this.nextTickActorPosition),this.createBalls&&(this.timePassedSinceLastBallCreated+=t,this.timePassedSinceLastBallCreated>.05&&(this.timePassedSinceLastBallCreated=0,this.createBall())),this.ballsViews.forEach((t=>{t.color=F(t.position.y)}))}processUserInput(t){const e=t;e.leftButtonDown?this.actor.solverObject.isPointInsideObject(new r(e.screenX,e.screenY))&&(this.createBalls=!0):this.createBalls=!1,(e.screenX||e.screenY)&&(this.nextTickActorPosition=new r(e.screenX,e.screenY))}set createBalls(t){this._createBalls=t,this.actor.renderItem.color=t?"#00ff00":"#ff0000"}get createBalls(){return this._createBalls}constructor(t){super(t),this._createBalls=!1,this.timePassedSinceLastBallCreated=0,this.ballIndex=0,this.ballsViews=[],this.center=new r(this.engine.canvas.width/2,this.engine.canvas.height/2),this.radius=Math.min(this.center.x,this.center.y),this.generator=new y(this.engine.solver),this.createActor(),this.initConstrain()}}};class K{resetTick(){this.tickData.forEach(((t,e)=>this.tickData[e]=0))}writeStats(t,e){const s=this.registerKey(t);this.tickData[s]=e,this.totalData[s]=e}addStats(t,e=1){const s=this.registerKey(t);this.tickData[s]+=e,this.totalData[s]+=e}registerKey(t){return this.keys.has(t)?this.keys.get(t):(this.tickData.push(0),this.totalData.push(0),this.keys.set(t,this.tickData.length-1),this.tickData.length-1)}getStats(t){if(!this.keys.has(t))return{key:t,total:0,tick:0};const e=this.keys.get(t);return{key:t,total:this.totalData[e],tick:this.tickData[e]}}getTickData(){const t=[];return this.keys.forEach(((e,s)=>{t.push({key:s,value:this.tickData[e]})})),t}constructor(){this.tickData=[],this.totalData=[],this.keys=new Map}}class q{clear(){this.objects.length>0&&this.objects.splice(0),this.divided&&this.nodes.forEach((t=>t.clear())),this.divided=!1}get canSubdivide(){return this.boundary.diag>this.minimumDiag}insert(t){if(!t.inside(this.boundary))return;if(this.objects.length<this.capacity)return this.objects.push(t),!0;if(!this.canSubdivide)return this.objects.push(t),!0;this.divided||(this.subdivide(),this.divided=!0);let e=0;for(;e<4;)this.nodes[e].insert(t)&&(e=5),e++;return 5===e}subdivide(){this.nodes[q.NW]=new q(this.boundary.nw,this.capacity),this.nodes[q.NE]=new q(this.boundary.ne,this.capacity),this.nodes[q.SE]=new q(this.boundary.se,this.capacity),this.nodes[q.SW]=new q(this.boundary.sw,this.capacity)}query(t){let e=[];return this.boundary.intersect(t)?(this.objects.forEach((s=>{s.intersects(t)&&e.push(s)})),this.divided&&this.nodes.forEach((s=>s.query(t).forEach((t=>e.push(t))))),e):e}debugRender(t){t.strokeStyle(this.objects.length>0?"#ff0000":"#00ff00"),t.rect(this.boundary.left,this.boundary.top,this.boundary.width-2,this.boundary.height-2),this.divided&&this.nodes.forEach((e=>e.debugRender(t)))}constructor(t,e){this.divided=!1,this.minimumDiag=10,this.boundary=t.copy(),this.capacity=e,this.objects=[],this.nodes=[],this.divided=!1}}q.NW=0,q.NE=1,q.SE=2,q.SW=3;class U extends c{clear(){this.root.clear()}addObject(t){this.root.insert(t)}addPointObject(t,e,s){this.root.insert(s)}addRectangularObject(t,e,s){this.root.insert(s)}debugRender(t){this.root.debugRender(t)}constructor(t,e){super(),this.root=new q(new S(new r(t/2,e/2),new r(t,e)),4)}}class W extends d{reset(){super.reset(),this.space.clear()}configure(){super.configure(),this.gravity=new r(0,100),this.space=new U(this.worldSize.x,this.worldSize.y)}processOptimizations(){this.space.clear(),this.objects.forEach(((t,e)=>{t.addToSpace(this.space),this.stats.addStats(`Solver object: ${t.toString()}`)}))}applyForces(){this.objects.forEach((t=>t.accelerate(this.gravity)))}processCollisions(){this.objects.forEach((t=>{const e=t.getCollisionRange(),s=this.space.root.query(e);this.stats.addStats("processCollisions.queryPossibleObjects.calls"),s.forEach((e=>{t!==e&&(t.immovable&&e.immovable||(this.stats.addStats("processCollisions.calls"),t.collide(e)))}))}))}debugRender(t){this.space.debugRender(t),this.objects.forEach((e=>e.debugRender(t)))}constructor(t,e){super(t,e),this.gravity=r.Zero(),this.configure()}}class Y{moveTo(t,e){this._position.moveTo(t,e)}constructor(){this._position=r.Zero()}}class H extends Y{getCoord(t,e){let s,i;return void 0===t?(s=this._position.x,i=this._position.y):t instanceof r?(s=t.x,i=t.y):(s=t,i=e),[s,i]}circle(t,e,s){const[i,n]=this.getCoord(e,s);this._context.beginPath(),this._context.arc(i,n,t,0,2*Math.PI),this._context.stroke()}fillCircle(t,e,s){const[i,n]=this.getCoord(e,s);this._context.beginPath(),this._context.arc(i,n,t,0,2*Math.PI),this._context.fill()}color(){}fillStyle(t){this._context.fillStyle=t}fillRect(t,e,s,i){this._context.fillRect(t,e,s-t,i-e)}line(t,e,s,i){e instanceof r?([t,e]=this.getCoord(t),[s,i]=this.getCoord(e)):[t,e]=this.getCoord(t,e),this._context.beginPath(),this._context.moveTo(t,e),this._context.lineTo(s,i),this._context.stroke()}vector(t,e){this._context.beginPath(),this._context.moveTo(t.x,t.y),this._context.lineTo(t.x+e.x,t.y+e.y),this._context.stroke()}rect(t,e,s,i){this._context.strokeRect(t,e,s,i)}text(t,e,s){const[i,n]=this.getCoord(e,s);this._context.fillStyle="#ffffff",this._context.textAlign="start",this._context.fillText(t,i,n)}moveTo(){}font(t){this._context.font=t}lineTo(t,e){const[s,i]=this.getCoord(t,e);this._context.moveTo(this._position.x,this._position.y),this._context.lineTo(s,i)}strokeStyle(t){this._context.strokeStyle=t}lineWidth(t){this._context.lineWidth=t}polygon(t){this._context.beginPath();let e=0;for(this._context.moveTo(t[e].x,t[e].y);e<t.length-1;)e++,this._context.lineTo(t[e].x,t[e].y);this._context.lineTo(t[0].x,t[0].y),this._context.stroke()}constructor(t){super(),this._context=t}}class J{reset(){this.objects=[],this.items=[],this.solver.reset()}switchToGridSolver(){const t=new u(new r(this.canvas.width,this.canvas.height),this.stats);this.solver&&(this.solver.objects.forEach((e=>t.addObject(e))),t.constrains=this._constrains),this.solver=t}switchToQuadSolver(){const t=new W(new r(this.canvas.width,this.canvas.height),this.stats);this.solver&&(this.solver.objects.forEach((e=>t.addObject(e))),t.constrains=this._constrains),this.solver=t}configure(){this.switchToGridSolver(),this.context.font("10px serif"),this.loadScene("scene1")}processUserInput(t){const e=t;"g"===e.keyPressed&&(this.flagRenderGrid=!this.flagRenderGrid),"p"===e.keyPressed&&(this.flagRenderPreviousPosition=!this.flagRenderPreviousPosition),"s"===e.keyPressed&&(this.flagSwitchSolver=!0),this.scene.processUserInput(t)}processEngineEvent(t){const e=t;e.scene&&this.loadScene(e.scene)}loadScene(t){this.reset();const e=$[t];this.scene=new e(this)}addObject(t){this.objects.push(t),this.solver.addObject(t.solverObject)}update(t){this.solver.update(t)}tick(){this.step<0&&(this.step=0);const t=this.step/1e3;this.scene.tick(t),this.update(t),this.clear(),this.renderItems(),this.flagRenderGrid&&this.renderGrid(),this.flagRenderPreviousPosition&&this.renderPreviousPosition(),this.printFPS(),this.stats.resetTick(),r.lengthCallsCount=0,r.length2CallsCount=0,this.flagSwitchSolver&&(this.solver instanceof u?this.switchToQuadSolver():this.switchToGridSolver(),this.flagSwitchSolver=!1)}renderItems(){this.items.forEach((t=>t.render())),this.objects.forEach((t=>t.render()))}printFPS(){this.context.fillStyle("rgba(0,0,0,0.1)"),this.context.fillRect(0,0,100,60),this.context.text(`${Math.round(this.step)} ms / ${Math.round(1e3/this.step)} FPS`,0,10),this.context.text(`Length calls: ${r.lengthCallsCount}`,0,20),this.context.text(`Lenght2 calls: ${r.length2CallsCount}`,0,30),this.context.text(`Objects: ${this.objects.length}`,0,40),this.context.text(`Compares per object: ${Math.round(r.lengthCallsCount/this.objects.length)}`,0,50);this.stats.getTickData().forEach(((t,e)=>{this.context.text(`${t.key}: ${t.value}`,0,10*e+60)}))}clear(){this.context.fillStyle("rgba(0, 0, 0, 0.9)"),this.context.fillRect(0,0,this.canvas.width,this.canvas.height)}start(){self.requestAnimationFrame?self.requestAnimationFrame(this.nextFrame):setInterval(this.nextInterval,16)}renderGrid(){this.solver.debugRender(this.context)}renderPreviousPosition(){this.objects.forEach((t=>{const e=t.solverObject.previousPosition;this.context.fillStyle("rgba(0, 0, 255, 0.5)"),this.context.fillCircle(10,e)}))}set constrain(t){this._constrains=t,this.solver.constrains=this._constrains}get constrain(){return this._constrains}constructor(t){this.objects=[],this._constrains=null,this.solver=null,this.flagRenderGrid=!1,this.flagRenderPreviousPosition=!1,this.flagSwitchSolver=!1,this.nextFrame=t=>{this.step=t-this.timeRenderEnd,this.step<0&&(this.step=0),this.tick(),this.timeRenderEnd=t,self.requestAnimationFrame(this.nextFrame)},this.nextInterval=()=>{this.timeRenderStart=performance.now(),this.step=this.timeRenderStart-this.timeRenderEnd,this.step<0&&(this.step=0),this.tick(),this.timeRenderEnd=performance.now()},this.stats=new K,this.canvas=t,this.context=new H(this.canvas.getContext("2d")),this.timeRenderStart=performance.now(),this.timeRenderEnd=performance.now(),this.step=0,this.objects=[],this.items=[],this.solver=null,this.configure()}}var Q,tt;(tt=Q||(Q={}))[tt.MessageNone=0]="MessageNone",tt[tt.MessageInit=1]="MessageInit",tt[tt.MessageUserInput=2]="MessageUserInput",tt[tt.MessageEngineEvent=3]="MessageEngineEvent";let et;onmessage=function(t){switch(t.data.type){case Q.MessageInit:et=new J(t.data.canvas),et.start();break;case Q.MessageUserInput:et&&et.processUserInput(t.data.event);break;case Q.MessageEngineEvent:et&&et.processEngineEvent(t.data.event)}}}();