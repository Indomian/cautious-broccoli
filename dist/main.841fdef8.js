!function(){function t(t,i,s){return i in t?Object.defineProperty(t,i,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[i]=s,t}class i{render(){}constructor(t){this.context=t}}class s extends i{render(){this.context.beginPath(),this.context.arc(this.x,this.y,this.r,0,2*Math.PI),this.context.fillStyle=this.color,this.context.fill()}constructor(i,s,e,h,r){super(i),t(this,"x",0),t(this,"y",0),t(this,"r",0),t(this,"color","#00ff00"),this.x=s,this.y=e,this.r=h,r&&(this.color=r)}}const e=1e-6;class h extends Error{}class r{add(t){return this.x+=t.x,this.y+=t.y,this}sub(t){return this.x-=t.x,this.y-=t.y,this}flipY(){return this.y=-this.y,this}flipX(){return this.x=-this.x,this}flip(){return this.x=-this.x,this.y=-this.y,this}equals(t){return c.distance(this,t)<e}sum(t){return new r(this.x+t.x,this.y+t.y)}diff(t){return new r(this.x-t.x,this.y-t.y)}mul(t){return new r(this.x*t,this.y*t)}copy(){return new r(this.x,this.y)}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}get normalized(){const t=this.length;return new r(this.x/t,this.y/t)}get perpendicular(){if(0===this.x){if(this.y>0)return r.Horizontal().normalized;if(this.y<0)return r.Horizontal().normalized.flip();throw new h}if(0===this.y){if(this.x>0)return r.Vertical().normalized;if(this.x<0)return r.Vertical().normalized.flip()}return new r(-this.y/this.x,1).normalized}static Zero(){return new r(0,0)}static Horizontal(){return new r(1,0)}static Vertical(){return new r(0,1)}constructor(i,s){t(this,"x",0),t(this,"y",0),this.x=i,this.y=s}}class n{inBetween(t){const i=c.diff(t,this.vec1).length,s=c.diff(this.vec2,t).length,h=c.diff(this.vec1,this.vec2).length;return r=h,n=i+s,o=e,Math.abs(r-n)<o;var r,n,o}calculateKB(){this.vec1.y===this.vec2.y?(this.b=this.vec1.y,this.k=0):this.vec1.x===this.vec2.x?(this.b=NaN,this.k=NaN):(this.b=(this.vec1.x*this.vec2.y-this.vec1.y*this.vec2.x)/(this.vec1.x-this.vec2.x),this.k=(this.vec1.y-this.vec2.y)/(this.vec1.x-this.vec2.x))}makeVec2FromX(t){return new r(t,this.k*t+this.b)}get B(){return this.b}get K(){return this.k}get length(){return c.distance(this.vec1,this.vec2)}get direction(){return c.diff(this.vec1,this.vec2)}static Vertical(t){return new n(new r(t,0),new r(t,Number.MAX_SAFE_INTEGER))}static Horizontal(t){return new n(new r(0,t),new r(Number.MAX_SAFE_INTEGER,t))}constructor(i,s){t(this,"vec1",r.Zero()),t(this,"vec2",r.Zero()),t(this,"k",0),t(this,"b",0),this.vec1=i,this.vec2=s,this.calculateKB()}}class o extends Error{}class c{static diff(t,i){return new r(t.x-i.x,t.y-i.y)}static mul(t,i){return new r(t.x*i,t.y*i)}static distance(t,i){return c.diff(t,i).length}static intersect(t,i){if(t.K===i.K)throw new o;if(isNaN(t.K)||isNaN(i.K))return isNaN(t.K)?i.makeVec2FromX(t.vec1.x):t.makeVec2FromX(i.vec1.x);{const s=(t.B-i.B)/(i.K-t.K);return t.makeVec2FromX(s)}}static dot(t,i){return t.x*i.x+t.y*i.y}static mirror(t,i){const s=i.direction.perpendicular.normalized;return t.copy().sub(s.mul(2*c.dot(t,s)))}}class a{update(t){const i=this.velocity;this.previousPosition=this.currentPosition.copy(),this.currentPosition.add(i.add(this.acc.mul(t*t))),this.acc=r.Zero()}accelerate(t){this.acc.add(t)}collide(t){const i=c.diff(this.currentPosition,t.currentPosition),s=i.length,e=this.radius+t.radius;if(s<this.radius+t.radius){const h=i.normalized,r=e-s;this.currentPosition.add(c.mul(h,this.radius/e*r*this.bounceValue)),t.currentPosition.sub(c.mul(h,t.radius/e*r*t.bounceValue))}}flip(){const t=this.currentPosition.copy();this.currentPosition=this.previousPosition,this.previousPosition=t}get velocity(){return c.diff(this.currentPosition,this.previousPosition)}set velocity(t){this.previousPosition=c.diff(this.currentPosition,t)}get movementVector(){return new n(this.previousPosition,this.currentPosition)}constructor(i){t(this,"previousPosition",r.Zero()),t(this,"currentPosition",r.Zero()),t(this,"acc",r.Zero()),t(this,"radius",10),t(this,"bounceValue",1.1),this.previousPosition=i,this.currentPosition=i}}class l{applyConstrain(t){}constructor(){}}class u extends l{get width(){return this._width}set width(t){this._width=t,this.recalculateSides()}get height(){return this._height}set height(t){this._height=t,this.recalculateSides()}recalculateSides(){this.top=new n(new r(this._width,0),new r(0,0)),this.right=new n(new r(this._width,0),new r(this._width,this._height)),this.bottom=new n(new r(0,this._height),new r(this._width,this._height)),this.left=new n(new r(0,this._height),new r(0,0))}applyConstrain(t){super.applyConstrain(t),this.checkConstrainWithSide(t,this.right),this.checkConstrainWithSide(t,this.left),this.checkConstrainWithSide(t,this.bottom),this.checkConstrainWithSide(t,this.top)}checkConstrainWithSide(t,i){const s=t.velocity,e=t.movementVector;s.copy().flip();try{const s=c.intersect(i,e),h=c.distance(s,t.currentPosition);if(h<t.radius){console.log(h);const e=i.direction.perpendicular.normalized;console.log(s,e),t.currentPosition=s.sum(e.mul(t.radius*t.bounceValue)),console.log(t.currentPosition)}}catch(t){}}constructor(i,s){super(),t(this,"_width",0),t(this,"_height",0),t(this,"left",n.Vertical(0)),t(this,"top",n.Horizontal(0)),t(this,"right",n.Vertical(0)),t(this,"bottom",n.Horizontal(0)),this.width=i,this.height=s}}class d extends l{applyConstrain(t){super.applyConstrain(t);const i=t.currentPosition.diff(this.center),s=i.length,e=t.radius;if(s>this.radius-e){const s=i.normalized;t.currentPosition=this.center.sum(s.mul(this.radius-e))}}constructor(i,s){super(),t(this,"center",r.Zero()),t(this,"radius",0),this.center=i,this.radius=s}}class p{getNextObject(t){return null}constructor(i){t(this,"solver",null),this.solver=i}}class f{constructor(i,s){t(this,"timeout",void 0),t(this,"object",void 0),this.timeout=i,this.object=s}}class v extends p{getNextObject(t){if(!(this.total>this.limit)&&(this.lastCreateTime+=t,this.lastCreateTime>this.delay)){const t=this.create();return this.lastCreateTime=0,this.total++,t}}constructor(t,i,s,e){super(t),this.limit=i,this.total=0,this.delay=s,this.create=e,this.lastCreateTime=0}}class w{configure(){this.gravity=new r(0,100)}update(t){const i=t/this.subSteps;for(let t=0;t<this.subSteps;t++)this.applyGravity(),this.applyConstrains(),this.processCollisions(),this.updateObjects(i)}updateObjects(t){this.objects.forEach((i=>i.update(t)))}applyGravity(){this.objects.forEach((t=>t.accelerate(this.gravity)))}applyConstrains(){this.objects.forEach((t=>this.constrains.applyConstrain(t)))}processCollisions(){this.objects.forEach((t=>{this.objects.forEach((i=>{t!==i&&t.collide(i)}))}))}constructor(){t(this,"objects",[]),t(this,"constrains",null),this.gravity=r.Zero(),this.objects=[],this.subSteps=8,this.configure()}}class x extends i{render(){this.context.fillStyle=this.color,this.context.fillRect(this.leftTop.x,this.leftTop.y,this.size.x,this.size.y)}constructor(i,s,e,h){super(i),t(this,"leftTop",r.Zero()),t(this,"size",r.Zero()),t(this,"color","#00ff00"),this.leftTop=s,this.size=e,h&&(this.color=h)}}new f(1,new a(new r(10,10))),new f(2,new a(new r(10,10))),new f(3,new a(new r(10,10)));class m{configure(){this.solver=new w,this.context.font="10px serif",this.switchToCircleConstrain(),this.solver.constrains=this.constrains,this.generator=new v(this.solver,100,.2,(()=>{const t=new a(new r(this.canvas.width/2,this.canvas.height/2));return t.velocity=new r(3,-.5).mul(1/this.solver.subSteps),t}))}update(t){const i=this.generator.getNextObject(t);i&&this.solver.objects.push(i),this.solver.update(t)}tick(){this.step<0&&(this.step=0),this.update(this.step/1e3),this.clear(),this.renderItems(),this.printFPS()}renderItems(){this.items.forEach((t=>t.render())),this.solver.objects.forEach((t=>{new s(this.context,t.currentPosition.x,t.currentPosition.y,t.radius).render()}))}printText(t,i,s){this.context.fillStyle="#000000",this.context.fillText(t,i,s)}printFPS(){this.printText(`${Math.round(this.step)} ms / ${Math.round(1e3/this.step)} FPS`,0,10)}clear(){this.context.fillStyle="#ffffff",this.context.fillRect(0,0,this.canvas.width,this.canvas.height)}start(){self.requestAnimationFrame?self.requestAnimationFrame(this.nextFrame):setInterval(this.nextInterval,16)}switchToCircleConstrain(){this.constrains=new d(new r(this.canvas.width/2,this.canvas.height/2),this.canvas.height/2),this.items.push(new s(this.context,this.canvas.width/2,this.canvas.height/2,this.canvas.height/2,"#000000"))}switchToViewportConstrain(){this.constrains=new u(this.canvas.width,this.canvas.height),this.items.push(new x(this.context,r.Zero(),new r(this.canvas.width,this.canvas.height),"#000000"))}constructor(i){t(this,"objects",[]),t(this,"constrains",null),t(this,"solver",null),t(this,"nextFrame",(t=>{this.step=t-this.timeRenderEnd,this.step<0&&(this.step=0),this.tick(),this.timeRenderEnd=t,self.requestAnimationFrame(this.nextFrame)})),t(this,"nextInterval",(()=>{this.timeRenderStart=performance.now(),this.step=this.timeRenderStart-this.timeRenderEnd,this.step<0&&(this.step=0),this.tick(),this.timeRenderEnd=performance.now()})),this.canvas=i,this.context=this.canvas.getContext("2d"),this.timeRenderStart=performance.now(),this.timeRenderEnd=performance.now(),this.step=0,this.items=[],this.generator=null,this.solver=null,this.configure()}}onmessage=function(t){console.log(t);new m(t.data.canvas).start()}}();
//# sourceMappingURL=main.841fdef8.js.map
