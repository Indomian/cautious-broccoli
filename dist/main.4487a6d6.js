!function(){function t(t,i,s){return i in t?Object.defineProperty(t,i,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[i]=s,t}const i=1e-6;class s extends Error{}class e{add(t){return this.x+=t.x,this.y+=t.y,this}sub(t){return this.x-=t.x,this.y-=t.y,this}flipY(){return this.y=-this.y,this}flipX(){return this.x=-this.x,this}flip(){return this.x=-this.x,this.y=-this.y,this}equals(t){return h.distance(this,t)<i}sum(t){return new e(this.x+t.x,this.y+t.y)}diff(t){return new e(this.x-t.x,this.y-t.y)}mul(t){return new e(this.x*t,this.y*t)}copy(){return new e(this.x,this.y)}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}get normalized(){const t=this.length;return new e(this.x/t,this.y/t)}get perpendicular(){if(0===this.x){if(this.y>0)return e.Horizontal().normalized;if(this.y<0)return e.Horizontal().normalized.flip();throw new s}if(0===this.y){if(this.x>0)return e.Vertical().normalized;if(this.x<0)return e.Vertical().normalized.flip()}return new e(-this.y/this.x,1).normalized}static Zero(){return new e(0,0)}static Horizontal(){return new e(1,0)}static Vertical(){return new e(0,1)}constructor(i,s){t(this,"x",0),t(this,"y",0),this.x=i,this.y=s}}class n{inBetween(t){const s=h.diff(t,this._vec1).length,e=h.diff(this._vec2,t).length,n=h.diff(this._vec1,this._vec2).length;return r=n,o=s+e,c=i,Math.abs(r-o)<c;var r,o,c}calculateKB(){this._vec1.y===this._vec2.y?(this.b=this._vec1.y,this.k=0):this._vec1.x===this._vec2.x?(this.b=NaN,this.k=NaN):(this.b=(this._vec1.x*this._vec2.y-this._vec1.y*this._vec2.x)/(this._vec1.x-this._vec2.x),this.k=(this._vec1.y-this._vec2.y)/(this._vec1.x-this._vec2.x))}makeVec2FromX(t){return new e(t,this.k*t+this.b)}copy(){return new n(this._vec1,this._vec2)}moveBy(t){this._vec1.add(t),this._vec2.add(t),this.calculateKB()}getPointProjection(t){const i=this.direction,s=h.diff(t,this._vec1),e=(s.length,h.dot(i,s)/this.length);return this._vec1.sum(this.ort.copy().mul(e))}get B(){return this.b}get K(){return this.k}get length(){return this._length}get direction(){return this._direction}get ort(){return this._normalized}get vec1(){return this._vec1}get vec2(){return this._vec2}static Vertical(t){return new n(new e(t,0),new e(t,Number.MAX_SAFE_INTEGER))}static Horizontal(t){return new n(new e(0,t),new e(Number.MAX_SAFE_INTEGER,t))}constructor(i,s){t(this,"_vec1",e.Zero()),t(this,"_vec2",e.Zero()),t(this,"_direction",null),t(this,"_length",0),t(this,"k",0),t(this,"b",0),this._vec1=i,this._vec2=s,this._direction=h.diff(this._vec1,this._vec2),this._length=this._direction.length,this._normalized=this._direction.normalized,this.calculateKB()}}class r extends Error{}class h{static diff(t,i){return new e(t.x-i.x,t.y-i.y)}static mul(t,i){return new e(t.x*i,t.y*i)}static distance(t,i){return h.diff(t,i).length}static intersect(t,i){if(t.K===i.K)throw new r;if(isNaN(t.K)||isNaN(i.K))return isNaN(t.K)?i.makeVec2FromX(t._vec1.x):t.makeVec2FromX(i._vec1.x);{const s=(t.B-i.B)/(i.K-t.K);return t.makeVec2FromX(s)}}static dot(t,i){return t.x*i.x+t.y*i.y}static mirror(t,i){const s=i.direction.perpendicular.normalized;return t.copy().sub(s.mul(2*h.dot(t,s)))}}class o{render(){}constructor(i,s){t(this,"position",e.Zero()),this.context=i,this.position=s}}class c extends o{render(){this.context.beginPath(),this.context.arc(this.position.x,this.position.y,this.r,0,2*Math.PI),this.context.fillStyle=this.color,this.context.fill()}constructor(i,s,e,n){super(i,s),t(this,"r",0),t(this,"color","#00ff00"),e&&(this.r=e),n&&(this.color=n)}}const a=1,u=2,l=3;function d(t,i){switch(t.type>i.type&&([i,t]=[t,i]),!0){case t.type===a&&i.type===a:return function(t,i){const s=h.diff(t.currentPosition,i.currentPosition),e=s.length,n=t.radius+i.radius;if(e<n){const r=s.normalized,o=n-e;t.currentPosition.add(h.mul(r,t.radius/n*o*t.bounceValue)),i.currentPosition.sub(h.mul(r,i.radius/n*o*i.bounceValue))}}(t,i);case t.type===a&&i.type===u:return function(t,i){const s=h.diff(t.currentPosition,i.currentPosition),e=s.length,n=t.radius+i.radius;if(e<n){const i=s.normalized,r=n-e;t.currentPosition.add(h.mul(i,t.radius/n*r*t.bounceValue))}}(t,i);case t.type===a&&i.type===l:return function(t,i){try{const s=i._line.getPointProjection(t.currentPosition);if(i._line.inBetween(s)){const i=h.diff(s,t.currentPosition);if(i.length<t.radius){const s=i.normalized,e=t.radius-i.length;t.currentPosition.sub(h.mul(s,e*t.bounceValue))}}}catch(t){}}(t,i);default:return}}class f{update(t){const i=this.velocity;this.previousPosition=this.currentPosition.copy(),this.currentPosition.add(i.add(this.acc.mul(t*t))),this.acc=e.Zero()}accelerate(t){return this.acc.add(t),this}setVelocity(t){return this.velocity=t,this}collide(t){d(this,t)}flip(){const t=this.currentPosition.copy();this.currentPosition=this.previousPosition,this.previousPosition=t}get velocity(){return h.diff(this.currentPosition,this.previousPosition)}set velocity(t){this.previousPosition=h.diff(this.currentPosition,t)}get movementVector(){return new n(this.previousPosition,this.currentPosition)}constructor(i,s){t(this,"previousPosition",e.Zero()),t(this,"currentPosition",e.Zero()),t(this,"acc",e.Zero()),t(this,"radius",10),t(this,"bounceValue",1.1),t(this,"type",a),this.previousPosition=i.copy(),this.currentPosition=i.copy(),void 0!==s&&(this.radius=s)}}class p{applyConstrain(t){}constructor(){}}class x extends p{get width(){return this._width}set width(t){this._width=t}get height(){return this._height}set height(t){this._height=t}applyConstrain(t){super.applyConstrain(t),t.currentPosition.x-t.radius<0&&(t.currentPosition.x=t.radius),t.currentPosition.x+t.radius>this._width&&(t.currentPosition.x=this._width-t.radius),t.currentPosition.y-t.radius<0&&(t.currentPosition.y=t.radius),t.currentPosition.y+t.radius>this._height&&(t.currentPosition.y=this._height-t.radius)}constructor(i,s){super(),t(this,"_width",0),t(this,"_height",0),this.width=i,this.height=s}}class y extends p{applyConstrain(t){super.applyConstrain(t);const i=t.currentPosition.diff(this.center),s=i.length,e=t.radius;if(s>this.radius-e){const s=i.normalized;t.currentPosition=this.center.sum(s.mul(this.radius-e))}}constructor(i,s){super(),t(this,"center",e.Zero()),t(this,"radius",0),this.center=i,this.radius=s}}class v{getNextObject(t){return null}constructor(i){t(this,"solver",null),this.solver=i}}class m{constructor(i,s){t(this,"timeout",void 0),t(this,"object",void 0),this.timeout=i,this.object=s}}class w extends v{getNextObject(t){if(!(this.total>this.limit)&&(this.lastCreateTime+=1,this.lastCreateTime>this.delay)){const t=this.create(this.total);return this.lastCreateTime=0,this.total++,t}}constructor(t,i,s,e){super(t),this.limit=i,this.total=0,this.delay=s,this.create=e,this.lastCreateTime=0}}class _{configure(){this.gravity=new e(0,100),this.useFixedTime=!0,this.step=.017/this.subSteps}addObject(t){this.objects.push(t)}update(t){const i=this.useFixedTime?this.step:t/this.subSteps;for(let t=0;t<this.subSteps;t++)this.applyGravity(),this.applyConstrains(),this.processCollisions(),this.updateObjects(i)}updateObjects(t){this.objects.forEach((i=>i.update(t)))}applyGravity(){this.objects.forEach((t=>t.accelerate(this.gravity)))}applyConstrains(){this.objects.forEach((t=>this.constrains.applyConstrain(t)))}processCollisions(){this.objects.forEach((t=>{this.objects.forEach((i=>{t!==i&&t.collide(i)}))}))}constructor(){t(this,"objects",[]),t(this,"constrains",null),this.gravity=e.Zero(),this.objects=[],this.subSteps=4,this.configure()}}class g extends o{render(){this.context.fillStyle=this.color,this.context.fillRect(this.position.x,this.position.y,this.position.x+this.size.x,this.position.y+this.size.y)}constructor(i,s,n,r){super(i,s),t(this,"size",e.Zero()),t(this,"color","#00ff00"),this.size=n,r&&(this.color=r)}}class b{update(){this.renderItem.position=this.ballsObject.currentPosition}render(){this.update(),this.renderItem.render()}constructor(i,s){t(this,"ballsObject",null),t(this,"renderItem",null),this.ballsObject=i,this.renderItem=s}}class P extends f{update(t){this.currentPosition=this._fixedPosition,this.previousPosition=this._fixedPosition}constructor(i,s){super(i,s),t(this,"type",u),t(this,"_fixedPosition",null),this._fixedPosition=i.copy()}}class j extends b{update(){super.update(),this.renderItem.direction=this.ballsObject._direction}constructor(i,s){super(i),t(this,"ballsObject",null),this.ballsObject=i,this.renderItem=s}}class z extends f{update(t){this.currentPosition=this._line._vec1,this.previousPosition=this._line._vec2}constructor(i,s){super(i,0),t(this,"_direction",void 0),t(this,"_line",void 0),t(this,"type",l),this._direction=s,this._line=new n(this.currentPosition.copy(),this.currentPosition.copy().sum(this._direction))}}class C extends o{render(){this.context.strokeStyle=this.color,this.context.beginPath(),this.context.moveTo(this.position.x,this.position.y),this.context.lineTo(this.position.x+this.direction.x,this.position.y+this.direction.y),this.context.stroke()}constructor(i,s,n,r){super(i,s),t(this,"direction",e.Zero()),t(this,"color","#00ff00"),this.direction=n,r&&(this.color=r)}}class E extends c{render(){super.render(),this.context.fillStyle=this.textColor,this.context.textBaseline="middle",this.context.textAlign="center",this.context.fillText(this.text,this.position.x,this.position.y)}constructor(i,s,e,n,r,h){super(i,s,e,n),t(this,"text",""),t(this,"textColor","#ffffff"),this.text=r,h&&(this.textColor=h)}}new m(1,new f(new e(10,10))),new m(2,new f(new e(10,10))),new m(3,new f(new e(10,10)));const O=[new e(60,110),new e(130,490),new e(330,490),new e(400,110)],S=[[O[0],h.diff(O[0],O[1]).flip()],[O[1],h.diff(O[1],O[2]).flip()],[O[2],h.diff(O[2],O[3]).flip()]],T={57:"#ffffff",78:"#ffffff",71:"#ffffff",86:"#ffffff",200:"#ffffff",202:"#ffffff",218:"#ffffff"};class V{configure(){this.solver=new _,this.context.font="10px serif",this.switchToViewportConstrain(),this.solver.constrains=this.constrains;new e(this.canvas.width/2,this.canvas.height/2);const t=new e(10,10),i=new e(3,-3).mul(1/this.solver.subSteps);this.generator=new w(this.solver,300,10,(s=>new b(new f(t,10).setVelocity(i),new E(this.context,e.Zero(),10,T[s],s,"#000000")))),this.addObject(new b(new P(new e(230,50),30),new c(this.context,e.Zero(),30,"#ff0000"))),S.forEach((t=>{this.addObject(new j(new z(t[0],t[1]),new C(this.context,e.Zero(),e.Zero(),"#ffffff")))}))}addObject(t){this.objects.push(t),this.solver.addObject(t.ballsObject)}update(t){this.solver.update(t)}generatorsTick(t){const i=this.generator.getNextObject(t);i&&this.addObject(i)}tick(){this.step<0&&(this.step=0),this.generatorsTick(this.step/1e3),this.update(this.step/1e3),this.clear(),this.renderItems(),this.printFPS()}renderItems(){this.items.forEach((t=>t.render())),this.objects.forEach((t=>t.render()))}printText(t,i,s){this.context.fillStyle="#ffffff",this.context.textAlign="start",this.context.fillText(t,i,s)}printFPS(){this.printText(`${Math.round(this.step)} ms / ${Math.round(1e3/this.step)} FPS`,0,10)}clear(){this.context.fillStyle="#ffffff",this.context.fillRect(0,0,this.canvas.width,this.canvas.height)}start(){self.requestAnimationFrame?self.requestAnimationFrame(this.nextFrame):setInterval(this.nextInterval,16)}switchToCircleConstrain(){this.constrains=new y(new e(this.canvas.width/2,this.canvas.height/2),this.canvas.height/2),this.items.push(new c(this.context,this.canvas.width/2,this.canvas.height/2,this.canvas.height/2,"#000000"))}switchToViewportConstrain(){this.constrains=new x(this.canvas.width,this.canvas.height),this.items.push(new g(this.context,e.Zero(),new e(this.canvas.width,this.canvas.height),"#000000"))}constructor(i){t(this,"objects",[]),t(this,"constrains",null),t(this,"solver",null),t(this,"nextFrame",(t=>{this.step=t-this.timeRenderEnd,this.step<0&&(this.step=0),this.tick(),this.timeRenderEnd=t,self.requestAnimationFrame(this.nextFrame)})),t(this,"nextInterval",(()=>{this.timeRenderStart=performance.now(),this.step=this.timeRenderStart-this.timeRenderEnd,this.step<0&&(this.step=0),this.tick(),this.timeRenderEnd=performance.now()})),this.canvas=i,this.context=this.canvas.getContext("2d"),this.timeRenderStart=performance.now(),this.timeRenderEnd=performance.now(),this.step=0,this.objects=[],this.items=[],this.generator=null,this.solver=null,this.configure()}}onmessage=function(t){console.log(t);new V(t.data.canvas).start()}}();
//# sourceMappingURL=main.4487a6d6.js.map
